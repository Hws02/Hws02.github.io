<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>NCC架构参照开发源码实现 | 首页</title><meta name="keywords" content="参照,用友,源码研究"><meta name="author" content="黄文胜,huangws2024@foxmail.com"><meta name="copyright" content="黄文胜"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="NCC架构参照开发源码实现"><meta name="application-name" content="NCC架构参照开发源码实现"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="NCC架构参照开发源码实现"><meta property="og:url" content="https://hws02.github.io/2024/10/23/NCC%E6%9E%B6%E6%9E%84%E5%8F%82%E7%85%A7%E5%BC%80%E5%8F%91%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0-%E7%94%A8%E5%8F%8B%E5%AE%9E%E4%B9%A0/index.html"><meta property="og:site_name" content="首页"><meta property="og:description" content="NCC架构参照开发源码研究1.参照​		在界面开发过程中，经常会出现需要引用系统中已定义的数据场景。在编辑界面通过弹出一个参照展示界面供选择参照来源数据。在开发过程中，会经常重复使用相同的 数据选择界面，例如单据上一般都会引用组织。因此需要提供一套统一的数据选择控件及服务，在业务单据开发时，只需要直"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2024/10/31/6722d69dc007a.jpg"><meta property="article:author" content="黄文胜"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2024/10/31/6722d69dc007a.jpg"><meta name="description" content="NCC架构参照开发源码研究1.参照​		在界面开发过程中，经常会出现需要引用系统中已定义的数据场景。在编辑界面通过弹出一个参照展示界面供选择参照来源数据。在开发过程中，会经常重复使用相同的 数据选择界面，例如单据上一般都会引用组织。因此需要提供一套统一的数据选择控件及服务，在业务单据开发时，只需要直"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://hws02.github.io/2024/10/23/NCC%E6%9E%B6%E6%9E%84%E5%8F%82%E7%85%A7%E5%BC%80%E5%8F%91%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0-%E7%94%A8%E5%8F%8B%E5%AE%9E%E4%B9%A0/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo-zeta-one.vercel.app/',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🔨 设计开发一条龙","🏃 脚踏实地行动派","🧱 团队小组发动机","🐔 蔡徐坤五年老粉","😭 Java应届黑奴"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 黄文胜","link":"链接: ","source":"来源: 首页","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: {"enable":true,"delay":100,"shiftDelay":200},
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '首页',
  title: 'NCC架构参照开发源码实现',
  postAI: '',
  pageFillDescription: 'NCC架构参照开发源码研究, 1.参照, 2.参照的业务场景, 3. 参照分类(样式截图), 4. 参照的实现原理, 5.代码研究, 6.参照前端, 7.YonBIP 参照创建（应用注册）, 8.讲解思路, 9.参照前端（React）, 10.参照后端（Java）-MVC 模式讲解, 具体流程, 1. 前端请求阶段, 2. 后端接收请求并初始化查询, 2.1 NCCAction.doAction() 作为操作入口, 2.2 执行 AbstractRefAction.execute() 处理查询条件, 3. 数据查询和处理阶段, 3.1 DefaultGridRefAction.processData() 生成查询 SQL, 3.2 NCGridRefDBProcessor.queryRefPks() 查询符合条件的主键, 3.3 NCGridRefDBProcessor.getRowsByPks() 查询参照数据行, 3.4 NCGridRefDBProcessor.constructResult() 封装结果, 4. 数据权限、多语言处理阶段, 5. 返回结果给前端, 6. 前端展示结果架构参照开发源码研究参照在界面开发过程中经常会出现需要引用系统中已定义的数据场景在编辑界面通过弹出一个参照展示界面供选择参照来源数据在开发过程中会经常重复使用相同的数据选择界面例如单据上一般都会引用组织因此需要提供一套统一的数据选择控件及服务在业务单据开发时只需要直接使用减少业务开发的工作量其次是基于表单模版进行开发时框架需要一套标准的数据选择控件已便于动态的进行控制当需要引用数据时使用统一的前端控件即可完成数据的选择而不需要开发为此在中提供了统一公共的数据选择控件及服务框架简称为参照参照管理即管理各个领域服务中注册的参照信息提供各个领域的参照查询编辑新增功能简单来说一个实体依赖另外一个实体的数据另外一个实体就叫参照参照是主要用于其他页面选择使用的参照就是对其他实体信息的参照和对照高级版参照前端通过配置属性控制参照的界面显示后端拼接查询参数数据的具体语句参照的业务场景使用参照的场景通常满足以下几个要求第一用户需要填写的数据不可以随意填写且已经存在于数据库第二这些数据是一些常用和固定的数据如组织部门人员岗位等第三用户在选择数据时需要进行权限过滤以防止用户越权选择自己无权管理的数据参照分类样式截图表型参照后端类需继承类前端配置中需加入的配置一次请求列表参照单多选单选下拉样式参照树形参照后端类需继承类前端配置中需加入和的配置一次请求单选多选树表型参照实际上是树形参照和表形参照的集合两次请求一次请求走树形参照一次请求走表形参照参照的实现原理参照所在数据库表为代码研究接口该接口定义了一个方法强制要求实现类必须实现方法处理请求并返回响应结果是一个抽象类提供了处理请求的标准化流程该类实现了一个接口包含请求参数处理操作执行和异常处理等核心逻辑用来存储操作码默认构造函数检查数据权限确保用户可以执行该操作核心方法处理请求执行制定操作存储解析后的请求参数存储操作执行后的结果获取请求参数执行前的预处理如果失败就返回执行核心逻辑操作失败后的处理异常处理返回执行结果在操作失败后提供子类重写在操作成功后提供子类重写操作执行前的预处理默认返回值允许操作执行子类可重写抽象方法子类必须实现这个方法用于定义具体操作的执行逻辑方法获取获取从请求中获取参数并转换为指定类型的对象获取参数类型默认返回获取处理业务异常根据不同类型的异常返回相应的错误信息处理不同类型的异常处理运行时异常处理未知异常方法生成器用于拼接语句中后的条件语句设置后条件语句中占位符对应的真实数据为了防止注入设置语句中的内容实现排序抽象的引用动作类继承了并实现了接口负责数据引用查询的操作无参构造执行引用查询操作请求对象查询参数查询结果异常如果显示常用数据如果没有指定主键设置主键初始化分页信息初始化单位主键处理并引用返回结果获取数据权限列字段如果未指定则返回引用源数据的主键字段获取额外的条件拼接语句中后的条件语句获取额外的参数设置后条件语句中占位符对应的真实数据为了防止注入获取引用的获取语言资源抽象方法子类必须实现该方法用于获取引用元数据获取构建器这是一个工厂方法返回构造器负责根据构建查询语句初始化单位主键处理数据多语言翻译处理通过中的多语言配置设置不同语言的显示值保证参照名称在不同语言环境下能正确展示用于枚举值的多语言处理对于枚举类型的字段系统通过多语言映射表返回相应语言的值确保参照数据中的枚举字段多语言化设置查询条件的值获取构造器初始化处理器根据条件查询参照主键处理查询出的参照主键根据主键查询所有所需的字段处理最后查询出的结果集构造返回结果返回数据参照前端点击事件参照表格后返回的对象参照创建应用注册讲解思路模型层视图层组件前端组件控制器层参照前端参照前端的相关属性配置前端主要设置了参照的相关属性包括多余配置领域模块名默认语言多语文件选择生成的参照类型表型参照树形参照树表型参照为参照标题名字是指参照输入框的占位提示文字即在输入框中还未输入任何内容时会显示的提示文本定义了参照弹窗中表格的列配置决定了弹窗中展示的数据列和它们的顺序这个配置通常与我们的业务需要相关业务需要列显示什么字段就进行配置是后端接口路径用于从后端获取参照数据当参照组件加载时系统会使用这个发送请求以获得可以选择的具体数据列表编码名称用于定义表格列的显示名称对应后端数据返回的字段名决定了表格中展示的数据源参照后端模式讲解参照类类是整个参照功能的入口类继承自该类主要用于处理用户从前端触发的参照请求并生成查询参照数据的关键元数据在这个类中我们看到最核心的部分是方法它构建并返回对象表示参照的元数据定义这个方法是的核心方法负责构建并返回参照元数据这个对象包含了参照所需的所有信息如字段名表名主键等这些信息用于后续的查询和数据展示包括以下几部分编码字段是表示在表格中展示的每条记录的编码字段名称字段是对应表格中展示的记录名称字段主键字段是这是数据库表的主键字段用于标识每条记录表名是表示从数据库中查询的表名多语言支持通过说明参照支持多语言主要作用定义当前参照的元数据包括参照表的名称参照字段编码名称主键以及是否支持多语言通过返回为的核心查询逻辑提供必要的元数据信息配置数据权限控制和是否显示被停用数据等业务规则如和存储的数据示例是一个抽象类继承自它为表格参照功能提供了默认的实现中定义了参照功能的几个核心方法帮助处理参照的查询逻辑尤其是通过方法完成对数据的查询与处理是负责实际数据库查询的处理器它结合和生成语句执行查询并将结果封装成和返回对象定义参照功能的数据结构如字段表名等方法是整个数据查询的核心步骤它负责通过进行查询构造执行查询处理主键与字段数据最后返回一个查询结果集职责执行查询逻辑根据中返回的以及前端传递的查询条件生成查询并执行查询数据处理通过数据库处理器进行主键查询字段查询并进一步处理查询出的数据返回查询结果最终将处理后的参照数据封装为对象返回给前端核心处理逻辑类获取构造器是一个接口负责生成查询语句在这里我们通过方法获取构造器对象包含了前端传递的查询条件如关键字分页信息过滤条件这些条件会用于生成查询通过的数据生成最终执行的查询语句处理条件拼接排序等复杂的操作初始化处理器是一个用于执行数据库查询的处理器它会结合元数据和生成查询调用会返回当前参照的元数据信息如字段名主键表名等用于生成用于构造查询的实际语句通过将和传入处理器能够构建出最终要执行的查询根据条件查询参照主键理器通过调用方法根据中的条件查询参照数据的主键返回一个主键数组表示数据库中符合查询条件的记录的主键值处理查询出的参照主键通过调用方法进一步处理查询出来的主键参照过滤处理特定的业务逻辑处理完之后返回一个更新后的主键数组根据主键查询所有所需的字段通过主键数组调用从数据库中查询每条记录的所有字段信息返回值是一个数组每个代表一个查询结果的行包含所有所需的字段如等处理最后查询出的结果集进一步处理查询出的数据行类似于处理主键的步骤对数据行进行额外的处理或过滤比如多语言处理字段格式化等处理完成回返回一个数组构造返回结果返回数据调用方法将处理过的和分页信息打包成一个对象是最终返回给前端的数据结构包含了查询的结果集和分页信息提供了很多参照功能中的基础逻辑如数据权限多语言处理构建等它通过接口实现查询构建并为参照功能提供了灵活的扩展接口会使用中存储的条件包括组织集团和其他过滤条件这些都是由入口类或设置的抽象的引用动作类继承了并实现了接口负责数据引用查询的操作控制是否展示被停用的数据负责数据权限的字段系统可以根据用户角色或组织权限来过滤参照数据无参构造执行引用查询操作请求对象查询参数查询结果异常将通用参数转换为从而可以访问参照数据特定的查询条件判断是否显示常用数据通过判断用户是否选择了查看常用数据即常用参照如果显示常用数据开始构建常用参照的系统会使用以便构建常用参照的查询确保常用数据查询能使用适当的构建规则设置单位主键组织过滤系统调用方法执行具体的参照数据查询并返回查询结果该对象包含查询后的数据和分页信息获取额外的条件拼接语句中后的条件语句获取额外的参数设置后条件语句中占位符对应的真实数据为了防止注入和提供了数据权限控制的组织和集团过滤条件入口类通过方法将这些组织集团作为条件传入确保只有当前用户所属的组织和集团数据可以被查询到获取构建器这是一个工厂方法返回构造器负责根据构建查询语句多语言翻译处理通过中的多语言配置设置不同语言的显示值保证参照名称在不同语言环境下能正确展示用于枚举值的多语言处理对于枚举类型的字段系统通过多语言映射表返回相应语言的值确保参照数据中的枚举字段多语言化和方法会进一步调用的权限和多语言处理逻辑多语言处理是一个抽象基础类定义了通用的操作流程和错误处理机制为具体的业务逻辑类例如参照功能类提供支持提供了执行业务操作的通用流程并定义了方法作为所有具体操作类的执行入口在参照功能中这个类的主要作用包括以下几方面标准化的操作流程定义了操作执行的通用流程包含参数获取预处理实际执行后处理和异常处理权限校验方法用于数据权限校验确保只有符合权限的数据可以被访问异常处理和处理不同类型的异常确保系统稳定运行并将合适的错误信息返回给用户是一个抽象类提供了处理请求的标准化流程该类实现了一个接口包含请求参数处理操作执行和异常处理等核心逻辑用来存储操作码默认构造函数检查数据权限确保用户可以执行该操作核心方法处理请求执行制定操作存储解析后的请求参数存储操作执行后的结果获取请求参数执行前的预处理如果失败就返回执行核心逻辑操作失败后的处理异常处理返回执行结果在操作失败后提供子类重写在操作成功后提供子类重写操作执行前的预处理默认返回值允许操作执行子类可重写抽象方法子类必须实现这个方法用于定义具体操作的执行逻辑方法获取获取从请求中获取参数并转换为指定类型的对象获取参数类型默认返回获取处理业务异常根据不同类型的异常返回相应的错误信息处理不同类型的异常处理运行时异常处理未知异常方法是参照功能中具体负责执行数据库操作的核心类它处理参照数据的查询结果处理等功能这个类的主要任务是通过与和协作生成查询语句并执行它最终返回参照数据这类的主要方法包括和根据用户输入的查询条件如关键字过滤条件等生成查询主键的语句并执行返回符合条件的主键数组判断是否进行全文检索如果需要全文检索通过方法生成基于关键字的查询结果非全文检索系统会根据分页信息来决定是查询所有主键调用还是根据分页信息分段查询调用当前页码为时查全部数据根据分页信息分段查询返回查询到的主键设置最大行数生成查询主键的语句用于从数据库中获取符合条件的主键数据根据中定义的表名和主键字段生成基础查询如果查询条件中有搜索主键系统会根据主键来过滤和方法分别用于生成条件和排序参照数据结构定义和用户查询条件构建基础查询参照主键参照表名如果有搜索主键添加过滤条件删除最后一个逗号生成条件和排序条件返回生成的查询语句根据主键数组查询对应的参照数据行并将数据封装为返回首先根据数组构建查询通过查询数据库中的实际数据查询结果为格式然后系统会将其转换为前端展示的格式方便前端展示通过这个服务对象调用数据库执行根据主键过滤的查询并返回数据库中存储的参照数据行根据主键查询具体的数据行是适合前端展示的数据格式包含了参照的等信息将转换为供前端使用的数据格式将查询结果封装为对象并处理分页信息将其返回给调用者根据数据计算分页信息并构建返回的结果通过来设置分页总页数和当前页的信息创建查询结果对象设置查询结果中的行数据获取查询参数中的分页信息计算总页数确保至少有一页根据总记录数和每页记录数计算总页数设置分页信息中的总页数设置查询结果中的分页信息是最终返回给调用者的数据对象它包含了查询的行数据以及分页信息整个参照流程包括前端发送查询条件后端接收和解析条件生成查询并执行数据库查询数据权限和多语言处理最终将结果返回前端并展示在这一过程中涉及多类协同工作确保查询高效灵活同时满足权限和多语言需求具体流程前端请求阶段用户在前端页面上操作可能选择某个字段的参照功能例如选择某个服务项目页面会展示一个参照弹窗允许用户根据关键字搜索分页浏览或选择组织等条件过滤数据用户输入的查询条件会通过请求或其他方式发送到后端后端接收请求并初始化查询作为操作入口是后端接收请求的入口类通过方法接收用户的查询请求调用方法读取并解析前端传来的查询条件将其封装为对象包含查询关键字分页信息过滤条件如组织主键过滤等执行处理查询条件在中调用方法此时进入类中实现的方法方法负责解析中的查询条件判断是否显示常用数据如果是则会附加的构建逻辑检查并设置组织主键为参照查询增加组织过滤初始化用于分页显示数据最终方法调用方法正式进入参照数据的查询处理阶段数据查询和处理阶段生成查询方法首先会获取构建器该对象生成参照功能的语句负责生成查询并调用数据库查询处理类执行查询查询符合条件的主键在中方法会根据查询条件生成语句判断是否需要进行全文检索如需要则调用否则按页面分页信息决定调用或执行查询后返回符合条件的主键数组查询参照数据行根据返回的主键数组会执行进一步的查询获取每条参照数据的完整行结果以的格式返回其中包含了每一行的编码名称主键等字段信息系统会将转换为格式这是前端更适合使用的数据格式封装结果方法将查询到的数据行封装为对象它还会处理分页信息如计算总页数设置等确保数据分页返回符合用户请求数据权限多语言处理阶段在中数据行会进一步经过权限控制和多语言处理确保符合用户权限的控制要求会处理多语言转换则进行主键过滤和权限控制确保只有符合权限的数据行被返回返回结果给前端最终返回对象将该结果封装并返回给前端前端接收数据该数据包含查询到的参照数据行和分页信息前端展示结果前端接收到后端返回的参照数据将其展示在参照弹窗中用户可以浏览分页内容查看参照的名称和编码等字段用户可以进一步选择或确认某个参照值从而完成整个参照功能的交互流程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-05 09:29:56',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://localhost:4000/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">首页</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><span> 隧道</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><span> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><span> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><span> 关于本人</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:toRandomPost()"><span> 随便逛逛</span></a></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Debug/" style="font-size: 1.05rem;">Debug<sup>4</sup></a><a href="/tags/Docker/" style="font-size: 1.05rem;">Docker<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem;">Java<sup>9</sup></a><a href="/tags/MySQL/" style="font-size: 1.05rem;">MySQL<sup>2</sup></a><a href="/tags/Nacos/" style="font-size: 1.05rem;">Nacos<sup>1</sup></a><a href="/tags/Redis/" style="font-size: 1.05rem;">Redis<sup>2</sup></a><a href="/tags/TCP/" style="font-size: 1.05rem;">TCP<sup>1</sup></a><a href="/tags/%E5%85%8B%E9%9A%86/" style="font-size: 1.05rem;">克隆<sup>1</sup></a><a href="/tags/%E5%8F%82%E7%85%A7/" style="font-size: 1.05rem;">参照<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">后端开发<sup>1</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem;">多线程<sup>1</sup></a><a href="/tags/%E5%A4%A7%E5%AD%A6/" style="font-size: 1.05rem;">大学<sup>2</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0/" style="font-size: 1.05rem;">学习<sup>1</sup></a><a href="/tags/%E5%AE%9E%E4%B9%A0/" style="font-size: 1.05rem;">实习<sup>6</sup></a><a href="/tags/%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">接口开发<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 1.05rem;">数据库<sup>5</sup></a><a href="/tags/%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6/" style="font-size: 1.05rem;">源码研究<sup>1</sup></a><a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size: 1.05rem;">生活<sup>1</sup></a><a href="/tags/%E7%94%A8%E5%8F%8B/" style="font-size: 1.05rem;">用友<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 1.05rem;">编程<sup>1</sup></a><a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/" style="font-size: 1.05rem;">自动化部署<sup>1</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 1.05rem;">设计模式<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 1.05rem;">面试<sup>16</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">25</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div class="console-btn-item" id="consoleKeyboard" onclick="anzhiyu.keyboardToggle()" title="快捷键开关"><a class="keyboard-switch"><i class="anzhiyufont anzhiyu-icon-keyboard"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E4%B9%A0/" itemprop="url">实习</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E5%8F%82%E7%85%A7/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>参照</span></a><a class="article-meta__tags" href="/tags/%E7%94%A8%E5%8F%8B/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>用友</span></a><a class="article-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>源码研究</span></a></span></div></div><h1 class="post-title" itemprop="name headline">NCC架构参照开发源码实现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-10-23T06:24:28.000Z" title="发表于 2024-10-23 14:24:28">2024-10-23</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-11-05T01:29:56.102Z" title="更新于 2024-11-05 09:29:56">2024-11-05</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">8.7k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>35分钟</span></span><span class="post-meta-separator"></span><span id="" data-flag-title="NCC架构参照开发源码实现"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为南昌"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>南昌</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/10/23/NCC%E6%9E%B6%E6%9E%84%E5%8F%82%E7%85%A7%E5%BC%80%E5%8F%91%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0-%E7%94%A8%E5%8F%8B%E5%AE%9E%E4%B9%A0/#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://bu.dusays.com/2024/10/31/6722d69dc007a.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://hws02.github.io/2024/10/23/NCC%E6%9E%B6%E6%9E%84%E5%8F%82%E7%85%A7%E5%BC%80%E5%8F%91%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0-%E7%94%A8%E5%8F%8B%E5%AE%9E%E4%B9%A0/"><header><a class="post-meta-categories" href="/categories/%E5%AE%9E%E4%B9%A0/" itemprop="url">实习</a><a href="/tags/%E5%8F%82%E7%85%A7/" tabindex="-1" itemprop="url">参照</a><a href="/tags/%E7%94%A8%E5%8F%8B/" tabindex="-1" itemprop="url">用友</a><a href="/tags/%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6/" tabindex="-1" itemprop="url">源码研究</a><h1 id="CrawlerTitle" itemprop="name headline">NCC架构参照开发源码实现</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">黄文胜</span><time itemprop="dateCreated datePublished" datetime="2024-10-23T06:24:28.000Z" title="发表于 2024-10-23 14:24:28">2024-10-23</time><time itemprop="dateCreated datePublished" datetime="2024-11-05T01:29:56.102Z" title="更新于 2024-11-05 09:29:56">2024-11-05</time></header><h1 id="NCC架构参照开发源码研究"><a href="#NCC架构参照开发源码研究" class="headerlink" title="NCC架构参照开发源码研究"></a>NCC架构参照开发源码研究</h1><h3 id="1-参照"><a href="#1-参照" class="headerlink" title="1.参照"></a>1.参照</h3><p>​		在界面开发过程中，经常会出现需要引用系统中已定义的数据场景。在编辑界面通过弹出一个参照展示界面供选择参照来源数据。在开发过程中，会经常重复使用相同的 数据选择界面，例如单据上一般都会引用组织。因此需要提供一套统一的数据选择控件及服务，在业务单据开发时，只需要直接使用，减少业务开发的工作量。其次是基于表单模版进行开发时，框架需要一套标准的数据选择控件，已便于动态的进行控制。当需要引用数据时，使用统一的前端控件即可完成数据的选择，而不需要开发。为此，在yonbip中提供了统一公共的数据选择控件及服务框架，简称为参照。 参照管理，即管理各个领域服务中注册的参照信息，提供各个领域的参照查询、编辑、新增功能，简单来说，一个实体依赖另外一个实体的数据，另外一个实体就叫参照，参照是主要用于其他页面选择使用的。</p>
<p>参照，就是对其他实体信息的参照和对照</p>
<p><strong>YonBIP高级版参照：</strong></p>
<ul>
<li>前端JS：通过配置属性控制参照的界面显示。</li>
<li>后端Java：拼接查询参数数据的具体SQL语句。</li>
</ul>
<h3 id="2-参照的业务场景"><a href="#2-参照的业务场景" class="headerlink" title="2.参照的业务场景"></a>2.参照的业务场景</h3><p>使用参照的场景通常满足以下几个要求：</p>
<ul>
<li>第一，用户需要填写的数据不可以随意填写，且已经存在于数据库。</li>
<li>第二，这些数据是一些常用和固定的数据，如组织、部门、人员、岗位等。</li>
<li>第三，用户在选择数据时需要进行权限过滤，以防止用户越权选择自己无权管理的数据。</li>
</ul>
<h3 id="3-参照分类-样式截图"><a href="#3-参照分类-样式截图" class="headerlink" title="3. 参照分类(样式截图)"></a>3. 参照分类(样式截图)</h3><ul>
<li>表型参照<ul>
<li>后端 Java 类需继承 <code>DefaultGridRefAction </code>类，前端 JS 配置中需加入 ColumnConfig 的配置一次请求。</li>
<li>列表参照(单&#x2F;多选)</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712d25561.png" alt="ncc1.png"></p>
<p> 单选</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712d58b9a.png" alt="ncc2.png"></p>
<p>下拉样式参照：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712d67556.png" alt="ncc3.png"></p>
<p>树形参照</p>
<p>​	后端 Java 类需继承 DefaultTreeRefAction 类，前端 JS 配置中需加入 rootNode 和 TreeConfig 的配置一次请求。</p>
<p>单选</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712d4f878.png" alt="ncc4.png"></p>
<p>多选</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712d60c04.png" alt="ncc5.png"></p>
<p>树表型参照</p>
<p>实际上是树形参照和表形参照的集合。两次请求，一次请求走树形参照 action，一次请求走表形参照 action。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712d65ced.png" alt="ncc6.png"></p>
<h3 id="4-参照的实现原理"><a href="#4-参照的实现原理" class="headerlink" title="4. 参照的实现原理"></a>4. 参照的实现原理</h3><p>参照所在数据库表为：bd_refinfo 。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712e569c6.png" alt="ncc8.png"></p>
<h3 id="5-代码研究"><a href="#5-代码研究" class="headerlink" title="5.代码研究"></a>5.代码研究</h3><p><strong>5.1 ICommonAction（接口）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> nccloud.framework.web.action.itf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> nccloud.framework.web.container.IRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICommonAction</span> &#123;</span><br><span class="line">    <span class="comment">//该接口定义了一个doAction方法。</span></span><br><span class="line">    <span class="comment">//强制要求实现类必须实现doAction方法，处理请求并返回响应结果</span></span><br><span class="line">    Object <span class="title function_">doAction</span><span class="params">(IRequest var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.2 NCCAction</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NCCAction 是一个抽象类，提供了处理 Web 请求的标准化流程。</span></span><br><span class="line"><span class="comment">//该类实现了一个ICommonAction接口，包含请求参数处理、操作执行和异常处理等核心逻辑</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">NCCAction</span> <span class="keyword">implements</span> <span class="title class_">ICommonAction</span> &#123;</span><br><span class="line">    <span class="comment">//用来存储操作码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">strMdOperateCode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">strOperateCode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">strResourceCode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//默认构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NCCAction</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查数据权限，确保用户可以执行该操作</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">checkDataPermission</span><span class="params">(IRequest request, Object objData)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DataPermissionAction</span> <span class="variable">dataPermissionAction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataPermissionAction</span>();</span><br><span class="line">        <span class="type">ValidationException</span> <span class="variable">validException</span> <span class="operator">=</span> dataPermissionAction.checkDataPermission(<span class="built_in">this</span>.getResourceCode(), <span class="built_in">this</span>.getMdOperateCode(), <span class="built_in">this</span>.getOperateCode(), objData);</span><br><span class="line">        dataPermissionAction.dealValidationException(validException);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//核心方法，处理请求，执行制定操作</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">doAction</span><span class="params">(IRequest request)</span> &#123;</span><br><span class="line">        Logger.debug(<span class="string">&quot;begin action--&gt;&quot;</span> + <span class="built_in">this</span>.getClass().getName() + <span class="string">&quot;.doAction()&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">para</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//存储解析后的请求参数</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//存储操作执行后的结果</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取请求参数</span></span><br><span class="line">            para = <span class="built_in">this</span>.getPara(request, <span class="built_in">this</span>.getParaClass());</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.doBeforeAction(request, para)) &#123;</span><br><span class="line">                <span class="comment">//执行前的预处理，如果失败就返回</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">var10</span> <span class="operator">=</span> result;</span><br><span class="line">                <span class="keyword">return</span> var10;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//执行核心逻辑</span></span><br><span class="line">            result = <span class="built_in">this</span>.execute(request, para);</span><br><span class="line">            <span class="built_in">this</span>.doAfterSuccess(request, para);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">            <span class="type">Exception</span> <span class="variable">ex</span> <span class="operator">=</span> var8;</span><br><span class="line">            <span class="built_in">this</span>.doAfterFailure(request, para);<span class="comment">//操作失败后的处理</span></span><br><span class="line">            <span class="built_in">this</span>.handleException(ex);<span class="comment">//异常处理</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Logger.debug(<span class="string">&quot;end action--&gt;&quot;</span> + <span class="built_in">this</span>.getClass().getName() + <span class="string">&quot;.doAction()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;<span class="comment">//返回执行结果</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在操作失败后，提供子类重写</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">doAfterFailure</span><span class="params">(IRequest request, T para)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在操作成功后，提供子类重写</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">doAfterSuccess</span><span class="params">(IRequest request, T para)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//操作执行前的预处理，默认返回值true，允许操作执行，子类可重写</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="type">boolean</span> <span class="title function_">doBeforeAction</span><span class="params">(IRequest request, T para)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//抽象方法，子类必须实现这个方法用于定义具体操作的执行逻辑</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;T&gt; Object <span class="title function_">execute</span><span class="params">(IRequest var1, T var2)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//getter方法</span></span><br><span class="line">    <span class="comment">//获取 MdOperateCode</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getMdOperateCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.strMdOperateCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 OperateCode</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getOperateCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.strOperateCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从请求中获取参数并转换为指定类型的对象</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getPara</span><span class="params">(IRequest request, Class paraClass)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">strRead</span> <span class="operator">=</span> request.read();</span><br><span class="line">        <span class="type">T</span> <span class="variable">para</span> <span class="operator">=</span> JsonFactory.create().fromJson(strRead, paraClass);</span><br><span class="line">        <span class="keyword">return</span> para;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 获取参数类型，默认返回 HashMap.class</span></span><br><span class="line">    <span class="keyword">protected</span> Class <span class="title function_">getParaClass</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> HashMap.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 获取 ResourceCode</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getResourceCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.strResourceCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理业务异常，根据不同类型的异常返回相应的错误信息</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleBusinessException</span><span class="params">(BusinessException ex)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">strMsg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BizLockFailedException) &#123;</span><br><span class="line">            strMsg = NCLangRes4VoTransl.getNCLangRes().getStrByID(<span class="string">&quot;uif2&quot;</span>, <span class="string">&quot;DefaultExceptionHanler-000004&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> LockFailedException) &#123;</span><br><span class="line">            strMsg = NCLangRes4VoTransl.getNCLangRes().getStrByID(<span class="string">&quot;uif2&quot;</span>, <span class="string">&quot;DefaultExceptionHanler-000000&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ValidationException) &#123;</span><br><span class="line">            strMsg = ((ValidationException)ex).getMessage();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> VersionConflictException) &#123;</span><br><span class="line">            strMsg = NCLangRes4VoTransl.getNCLangRes().getStrByID(<span class="string">&quot;uif2&quot;</span>, <span class="string">&quot;DefaultExceptionHanler-000002&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            strMsg = ex.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ExceptionUtils.wrapBusinessException(strMsg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理不同类型的异常</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleException</span><span class="params">(Exception ex)</span> &#123;</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">ex2</span> <span class="operator">=</span> ExceptionUtils.unmarsh(ex);</span><br><span class="line">        Logger.error(<span class="string">&quot;**************************************************** NCCAction Error ****************************************************&quot;</span>);</span><br><span class="line">        Logger.error(ex2.getMessage(), ex);</span><br><span class="line">        <span class="keyword">if</span> (ex2 <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleRuntimeException((RuntimeException)ex2);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex2 <span class="keyword">instanceof</span> BusinessException) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleBusinessException((BusinessException)ex2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleUnknownException(ex2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//处理运行时异常</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleRuntimeException</span><span class="params">(RuntimeException ex)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> FrameworkSecurityException) &#123;</span><br><span class="line">            ExceptionUtils.wrapBusinessException(NCLangRes4VoTransl.getNCLangRes().getStrByID(<span class="string">&quot;uif2&quot;</span>, <span class="string">&quot;DefaultExceptionHanler-000006&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BusinessExceptionAdapter) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleBusinessException(((BusinessExceptionAdapter)ex).originalException);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(ex <span class="keyword">instanceof</span> nccloud.base.exception.BusinessException) &amp;&amp; !(ex <span class="keyword">instanceof</span> nccloud.framework.core.exception.BusinessException)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleUnknownException(ex);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleUnknownException(ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//处理未知异常</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleUnknownException</span><span class="params">(Throwable ex)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">strMsg</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(strMsg)) &#123;</span><br><span class="line">            strMsg = NCLangRes4VoTransl.getNCLangRes().getStrByID(<span class="string">&quot;uif2&quot;</span>, <span class="string">&quot;DefaultExceptionHanler-000001&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">BusinessException</span> <span class="variable">business</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(strMsg);</span><br><span class="line">        business.setStackTrace(ex.getStackTrace());</span><br><span class="line">        ExceptionUtils.wrapException(business);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//setter方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMdOperateCode</span><span class="params">(String mdOperateCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.strMdOperateCode = mdOperateCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOperateCode</span><span class="params">(String operateCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.strOperateCode = operateCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResourceCode</span><span class="params">(String resourceCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.strResourceCode = resourceCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.3 IRefSqlBuilder</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SQL生成器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRefSqlBuilder</span> &#123;</span><br><span class="line">    <span class="comment">//用于拼接Sql语句中where 后的条件语句</span></span><br><span class="line">    String <span class="title function_">getExtraSql</span><span class="params">(RefQueryInfo var1, RefMeta var2)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置where后条件语句中占位符对应的真实数据（为了防止Sql注入）</span></span><br><span class="line">    SqlParameterCollection <span class="title function_">getExtraSqlParameter</span><span class="params">(RefQueryInfo var1, RefMeta var2)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置SQL语句中的order by内容--实现排序</span></span><br><span class="line">    String <span class="title function_">getOrderSql</span><span class="params">(RefQueryInfo var1, RefMeta var2)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.4 AbstractRefAction</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 抽象的引用动作类，继承了NCCAction并实现了IRefSqlBuilder接口，负责数据引用查询的操作</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractRefAction</span> <span class="keyword">extends</span> <span class="title class_">NCCAction</span> <span class="keyword">implements</span> <span class="title class_">IRefSqlBuilder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">blShowDisabledData</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String strDataPowerColumn;</span><br><span class="line">    <span class="keyword">private</span> String strMdClassId;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">strUnitPkKey</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">strUsualDataPkFieldName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">strUsualDataTableName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//无参构造</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbstractRefAction</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行引用查询操作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request 请求对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> para 查询参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 查询结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Object <span class="title function_">execute</span><span class="params">(IRequest request, T para)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TreeRefQueryInfo</span> <span class="variable">refQueryInfo</span> <span class="operator">=</span> (TreeRefQueryInfo) para;</span><br><span class="line">        Map&lt;String, String&gt; queryCondition = refQueryInfo.getQueryCondition();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isShowUsual</span> <span class="operator">=</span> UFBoolean.valueOf(queryCondition.get(<span class="string">&quot;isShowUsual&quot;</span>)).booleanValue();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果显示常用数据</span></span><br><span class="line">        <span class="keyword">if</span> (isShowUsual) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">strUsualGridRefActionExt</span> <span class="operator">=</span> queryCondition.get(<span class="string">&quot;UsualGridRefActionExt&quot;</span>);</span><br><span class="line">            strUsualGridRefActionExt = StringUtils.isBlank(strUsualGridRefActionExt)</span><br><span class="line">                    ? UsualRefSqlBuilder.class.getName()</span><br><span class="line">                    : strUsualGridRefActionExt + <span class="string">&quot;,&quot;</span> + UsualRefSqlBuilder.class.getName();</span><br><span class="line">            <span class="type">String</span> <span class="variable">gridRefActionExts</span> <span class="operator">=</span> queryCondition.get(<span class="string">&quot;GridRefActionExt&quot;</span>);</span><br><span class="line">            gridRefActionExts = StringUtils.isBlank(gridRefActionExts)</span><br><span class="line">                    ? strUsualGridRefActionExt</span><br><span class="line">                    : gridRefActionExts + <span class="string">&quot;,&quot;</span> + strUsualGridRefActionExt;</span><br><span class="line">            queryCondition.put(<span class="string">&quot;GridRefActionExt&quot;</span>, gridRefActionExts);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果没有指定主键，设置主键</span></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(<span class="built_in">this</span>.getQueryValue(refQueryInfo, <span class="string">&quot;unitPks&quot;</span>))) &#123;</span><br><span class="line">                <span class="built_in">this</span>.setQueryValue(refQueryInfo, <span class="string">&quot;unitPks&quot;</span>, <span class="built_in">this</span>.getPk_org(refQueryInfo));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 初始化分页信息</span></span><br><span class="line">            <span class="built_in">this</span>.initPageInfo(refQueryInfo.getPageInfo());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化单位主键</span></span><br><span class="line">        <span class="built_in">this</span>.initUnitPk(refQueryInfo, <span class="built_in">this</span>.getKeyUnitPks());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理并引用返回结果</span></span><br><span class="line">        <span class="type">RefQueryResult</span> <span class="variable">refQueryResult</span> <span class="operator">=</span> <span class="built_in">this</span>.processData(refQueryInfo);</span><br><span class="line">        <span class="keyword">return</span> refQueryResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数据权限列字段，如果未指定则返回引用源数据的主键字段</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getDataPowerColumn</span><span class="params">(RefQueryInfo refQueryInfo, RefMeta refMeta)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.isBlank(<span class="built_in">this</span>.strDataPowerColumn) ? refMeta.getPkField() : <span class="built_in">this</span>.strDataPowerColumn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取额外的SQL条件，拼接Sql语句中where 后的条件语句</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getExtraSql</span><span class="params">(RefQueryInfo refQueryInfo, RefMeta refMeta)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取额外的SQL参数,设置where后条件语句中占位符对应的真实数据（为了防止Sql注入）</span></span><br><span class="line">    <span class="keyword">public</span> SqlParameterCollection <span class="title function_">getExtraSqlParameter</span><span class="params">(RefQueryInfo refQueryInfo, RefMeta refMeta)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取引用的VO</span></span><br><span class="line">    <span class="keyword">protected</span> RefVO_mlang[] getMultiLangRefVO() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取语言资源</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getMultiLangResource</span><span class="params">(String strDirName, String strFieldValue, String strResId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> NCLangRes4VoTransl.getNCLangRes().getString(strDirName, strFieldValue, strResId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽象方法，子类必须实现该方法，用于获取引用元数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> RefMeta <span class="title function_">getRefMeta</span><span class="params">(RefQueryInfo var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取SQL构建器</span></span><br><span class="line">    <span class="comment">//这是一个工厂方法，返回 SQL 构造器</span></span><br><span class="line">    <span class="comment">//DefaultRefSqlBuilder 负责根据 RefQueryInfo 构建 SQL 查询语句。</span></span><br><span class="line">    <span class="keyword">protected</span> IRefSqlBuilder <span class="title function_">getRefSqlBuilder</span><span class="params">(RefQueryInfo refQueryInfo)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultRefSqlBuilder</span>(<span class="built_in">this</span>, <span class="built_in">this</span>, refQueryInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化单位主键</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initUnitPk</span><span class="params">(RefQueryInfo refQueryInfo, String strQueryKey)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isBlank(strQueryKey)) &#123;</span><br><span class="line">            String[] strUnitPks = <span class="built_in">this</span>.getUnitPks(refQueryInfo);</span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.isEmpty(strUnitPks) &amp;&amp; !StringUtils.isBlank(strUnitPks[<span class="number">0</span>])) &#123;</span><br><span class="line">                <span class="built_in">this</span>.setQueryValue(refQueryInfo, strQueryKey, strUnitPks[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理数据</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> RefQueryResult <span class="title function_">processData</span><span class="params">(TreeRefQueryInfo var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多语言翻译处理</span></span><br><span class="line">    <span class="comment">// 通过 RefVO_mlang 中的多语言配置，设置不同语言的显示值，保证参照名称在不同语言环境下能正确展示。</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processMultiLang</span><span class="params">(RefQueryInfo refQueryInfo, RefRow refRow)</span> &#123;</span><br><span class="line">        RefVO_mlang[] multiLangRefVOs = <span class="built_in">this</span>.getMultiLangRefVO();</span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.isEmpty(multiLangRefVOs)) &#123;</span><br><span class="line">            Map&lt;String, Cell&gt; mapRowValues = refRow.getValues();</span><br><span class="line">            <span class="keyword">for</span> (RefVO_mlang mlRefVO : multiLangRefVOs) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">strResId</span> <span class="operator">=</span> mlRefVO.getPreStr();</span><br><span class="line">                String[] strResIdFieldNames = mlRefVO.getResIDFieldNames();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!ArrayUtils.isEmpty(strResIdFieldNames)) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (String fieldName : strResIdFieldNames) &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">objValue</span> <span class="operator">=</span> mapRowValues.get(fieldName).getValue();</span><br><span class="line">                        <span class="keyword">if</span> (objValue != <span class="literal">null</span>) &#123;</span><br><span class="line">                            strResId += objValue.toString();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">Object</span> <span class="variable">objFieldValue</span> <span class="operator">=</span> mapRowValues.get(mlRefVO.getFieldName()).getValue();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">strDirName</span> <span class="operator">=</span> mlRefVO.getDirName();</span><br><span class="line">                    <span class="keyword">if</span> (mlRefVO.getDirFieldName() != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">objDirFieldName</span> <span class="operator">=</span> mapRowValues.get(mlRefVO.getDirFieldName()).getValue();</span><br><span class="line">                        <span class="keyword">if</span> (objDirFieldName != <span class="literal">null</span>) &#123;</span><br><span class="line">                            strDirName = objDirFieldName.toString();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">String</span> <span class="variable">strFieldValue</span> <span class="operator">=</span> objFieldValue == <span class="literal">null</span> ? <span class="literal">null</span> : objFieldValue.toString();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">strMultiLang</span> <span class="operator">=</span> <span class="built_in">this</span>.getMultiLangResource(strDirName, strFieldValue, strResId);</span><br><span class="line">                    mapRowValues.get(mlRefVO.getFieldName()).setValue(strMultiLang);</span><br><span class="line"></span><br><span class="line">                    <span class="type">RefMeta</span> <span class="variable">refMeta</span> <span class="operator">=</span> <span class="built_in">this</span>.getRefMeta(refQueryInfo);</span><br><span class="line">                    <span class="keyword">if</span> (refMeta != <span class="literal">null</span> &amp;&amp; ObjectUtils.equals(refMeta.getNameField(), mlRefVO.getFieldName())) &#123;</span><br><span class="line">                        refRow.setRefname(strMultiLang);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于枚举值的多语言处理。对于枚举类型的字段</span></span><br><span class="line">    <span class="comment">//系统通过多语言映射表返回相应语言的值，确保参照数据中的枚举字段多语言化。</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processMultiLangForEnum</span><span class="params">(RefQueryInfo refQueryInfo, RefRow refRow)</span> &#123;</span><br><span class="line">        Map&lt;String, Map&lt;String, String&gt;&gt; mapRes = <span class="built_in">this</span>.getMultiLangForEnum();</span><br><span class="line">        <span class="keyword">if</span> (!MapUtils.isEmpty(mapRes)) &#123;</span><br><span class="line">            Map&lt;String, Cell&gt; mapRowValues = refRow.getValues();</span><br><span class="line">            <span class="keyword">for</span> (String strEnumFieldName : mapRes.keySet()) &#123;</span><br><span class="line">                <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> mapRowValues.get(strEnumFieldName);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">objFieldValue</span> <span class="operator">=</span> cell.getValue();</span><br><span class="line">                <span class="type">String</span> <span class="variable">strMultiLang</span> <span class="operator">=</span> mapRes.get(strEnumFieldName).get(objFieldValue);</span><br><span class="line">                cell.setValue(strMultiLang);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> String[] processRefPks(RefQueryInfo refQueryInfo, IRefSqlBuilder refSqlBuilder, String... strQueryRefPks) &#123;</span><br><span class="line">        <span class="keyword">return</span> strQueryRefPks;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> RefRow[] processRefRows(RefQueryInfo refQueryInfo, IRefSqlBuilder refSqlBuilder, RefRow... refRows) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.isEmpty(refRows)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (RefRow refRow : refRows) &#123;</span><br><span class="line">                <span class="built_in">this</span>.processMultiLang(refQueryInfo, refRow);</span><br><span class="line">                <span class="built_in">this</span>.processMultiLangForEnum(refQueryInfo, refRow);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> refRows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置查询条件的值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setQueryValue</span><span class="params">(RefQueryInfo refQueryInfo, String strQueryKey, String strQueryValue)</span> &#123;</span><br><span class="line">        refQueryInfo.getQueryCondition().put(strQueryKey, strQueryValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.5 DefaultGridRefAction</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">DefaultGridRefAction</span> <span class="keyword">extends</span> <span class="title class_">AbstractRefAction</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DefaultGridRefAction</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> RefMeta <span class="title function_">getRefMeta</span><span class="params">(RefQueryInfo var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initPageInfo</span><span class="params">(PageInfo pageInfo)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> RefQueryResult <span class="title function_">processData</span><span class="params">(TreeRefQueryInfo refQueryInfo)</span> &#123;</span><br><span class="line">        <span class="comment">//1.获取SQL构造器</span></span><br><span class="line">        <span class="type">IRefSqlBuilder</span> <span class="variable">refSqlBuilder</span> <span class="operator">=</span> <span class="built_in">this</span>.getRefSqlBuilder(refQueryInfo);</span><br><span class="line">        <span class="comment">//2.初始化处理器</span></span><br><span class="line">        <span class="type">NCGridRefDBProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NCGridRefDBProcessor</span>(<span class="built_in">this</span>.getRefMeta(refQueryInfo), refSqlBuilder);</span><br><span class="line">        <span class="comment">//3.根据条件查询参照主键</span></span><br><span class="line">        String[] strQueryRefPks = processor.queryRefPks(refQueryInfo);</span><br><span class="line">        <span class="comment">//4.处理查询出的参照主键</span></span><br><span class="line">        strQueryRefPks = <span class="built_in">this</span>.processRefPks(refQueryInfo, refSqlBuilder, strQueryRefPks);</span><br><span class="line">        <span class="comment">//5.根据主键查询所有所需的字段</span></span><br><span class="line">        RefRow[] refRows = processor.getRowsByPks(strQueryRefPks);</span><br><span class="line">        <span class="comment">//6.处理最后查询出的结果集</span></span><br><span class="line">        refRows = <span class="built_in">this</span>.processRefRows(refQueryInfo, refSqlBuilder, refRows);</span><br><span class="line">        <span class="comment">//7.构造返回结果，返回数据</span></span><br><span class="line">        <span class="type">RefQueryResult</span> <span class="variable">refQueryResult</span> <span class="operator">=</span> processor.constructResult(refRows, refQueryInfo);</span><br><span class="line">        <span class="keyword">return</span> refQueryResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.6 NCGridRefDBProcesso</strong></p>
<p><strong>5.7 Tax_hws_serviceDefaultGridRefAction</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tax_hws_serviceDefaultGridRefAction</span> <span class="keyword">extends</span> <span class="title class_">DefaultGridRefAction</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Tax_hws_serviceDefaultGridRefAction</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="built_in">super</span>();</span><br><span class="line">       setResourceCode(IOrgResourceCodeConst.ORG);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RefMeta <span class="title function_">getRefMeta</span><span class="params">(RefQueryInfo refQueryInfo)</span> &#123;</span><br><span class="line">       <span class="type">RefMeta</span> <span class="variable">refMeta</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RefMeta</span>();      </span><br><span class="line">       setResourceCode(IOrgResourceCodeConst.ORG);</span><br><span class="line">       refMeta.setCodeField(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">       refMeta.setNameField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">       </span><br><span class="line">       refMeta.setPkField(<span class="string">&quot;pk_vtax_tax_hws_service&quot;</span>);</span><br><span class="line">       refMeta.setTableName(<span class="string">&quot;vtax_tax_hws_service&quot;</span>);</span><br><span class="line">       refMeta.setMutilLangNameRef(<span class="literal">true</span>);</span><br><span class="line">       <span class="keyword">return</span> refMeta;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-参照前端"><a href="#6-参照前端" class="headerlink" title="6.参照前端"></a>6.参照前端</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712e89915.png" alt="ncc9.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712ea054a.png" alt="ncc10.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712ed8c26.png" alt="ncc12.png"></p>
<p>点击（事件）参照表格后返回的 json 对象：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712f3974c.png" alt="ncc13.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712f7c96c.png" alt="ncc14.png"></p>
<h3 id="7-YonBIP-参照创建（应用注册）"><a href="#7-YonBIP-参照创建（应用注册）" class="headerlink" title="7.YonBIP 参照创建（应用注册）"></a>7.YonBIP 参照创建（应用注册）</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729712fc1b51.png" alt="ncc15.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/6729713025e64.png" alt="ncc16.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/67297130a38b1.png" alt="ncc17.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/67297130293e7.png" alt="ncc18.png"></p>
<h3 id="8-讲解思路"><a href="#8-讲解思路" class="headerlink" title="8.讲解思路"></a>8.讲解思路</h3><ol>
<li><strong>模型层 （Model）</strong><ol>
<li><strong><code>NCGridRefDBProcessor</code></strong></li>
<li><strong><code>IRefSqlBuilder</code></strong></li>
<li><code>INCDataQuery</code></li>
<li><code>IMultiNCGridRefRowService</code></li>
<li><code>ServiceLocator</code></li>
</ol>
</li>
<li><strong>视图层 （View）</strong><ol>
<li><code>Refer</code> 组件（前端 React 组件）</li>
</ol>
</li>
<li><strong>控制器层 （<strong><strong>Controller</strong></strong>）</strong><ol>
<li><strong><code>DefaultGridRefAction</code></strong></li>
<li><strong><code>AbstractRefAction</code></strong></li>
<li><code>NCCAction</code></li>
</ol>
</li>
</ol>
<h3 id="9-参照前端（React）"><a href="#9-参照前端（React）" class="headerlink" title="9.参照前端（React）"></a>9.参照前端（React）</h3><ul>
<li><p>参照前端的相关属性配置</p>
</li>
<li><p>前端主要设置了参照的相关属性，包括多余配置（领域模块名、默认语言、多语文件）；</p>
</li>
<li><p>选择生成的参照类型（grid-表型参照；tree-树形参照；gridtree-树表型参照）；</p>
</li>
<li><p><code>refName</code>为参照标题名字，</p>
</li>
<li><p><code>placeholder</code> 是指<strong>参照输入框的占位提示文字</strong>，即在输入框中还未输入任何内容时，会显示的提示文本。</p>
</li>
<li><p><code>columnConfig</code> 定义了<strong>参照弹窗中表格的列配置</strong>，决定了弹窗中展示的数据列和它们的顺序。这个配置通常与我们的业务需要相关，业务需要列显示什么字段就进行配置；</p>
</li>
<li><p><code>queryGridUrl</code> 是<strong>后端接口路径</strong>，用于从后端获取参照数据。当参照组件加载时，系统会使用这个 URL 发送请求，以获得可以选择的具体数据列表。</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">columnConfig</span>: [&#123;<span class="attr">name</span>: [<span class="string">&#x27;编码&#x27;</span>, <span class="string">&#x27;名称&#x27;</span>], <span class="attr">code</span>: [<span class="string">&#x27;refcode&#x27;</span>, <span class="string">&#x27;refname&#x27;</span>]&#125;]</span><br><span class="line"><span class="comment">//name: 用于定义表格列的显示名称。</span></span><br><span class="line"><span class="comment">//code: 对应后端数据返回的字段名，决定了表格中展示的数据源。</span></span><br></pre></td></tr></table></figure>

<h3 id="10-参照后端（Java）-MVC-模式讲解"><a href="#10-参照后端（Java）-MVC-模式讲解" class="headerlink" title="10.参照后端（Java）-MVC 模式讲解"></a>10.参照后端（Java）-MVC 模式讲解</h3><p>​	1.参照类<code>Tax_hws_serviceDefaultGridRefAction</code></p>
<ul>
<li><p><code>Tax_hws_serviceDefaultGridRefAction</code> 类是整个参照功能的入口类，继承自 <code>DefaultGridRefAction</code>，该类主要用于处理用户从前端触发的参照请求，并生成查询参照数据的关键元数据。在这个类中，我们看到最核心的部分是 <code>getRefMeta()</code> 方法，它构建并返回 <code>RefMeta</code> 对象，表示参照的元数据定义。</p>
</li>
<li><p><code>getRefMeta(RefQueryInfo refQueryInfo)</code> 这个方法是 <code>Tax_hws_serviceDefaultGridRefAction</code> 的核心方法，负责构建并返回参照元数据 <code>RefMeta</code>，这个对象包含了参照所需的所有信息（如字段名、表名、主键等），这些信息用于后续的 SQL 查询和数据展示。包括以下几部分：</p>
<ul>
<li><strong>编码字段</strong>：<code>codeField</code> 是 <code>code</code>，表示在表格中展示的每条记录的编码字段。</li>
<li><strong>名称字段</strong>：<code>nameField</code> 是 <code>name</code>，对应表格中展示的记录名称字段。</li>
<li><strong>主键字段</strong>：<code>pkField</code> 是 <code>pk_vtax_tax_hws_service</code>，这是数据库表 <code>vtax_tax_hws_service</code> 的主键字段，用于标识每条记录。</li>
<li><strong>表名</strong>：<code>tableName</code> 是 <code>vtax_tax_hws_service</code>，表示从数据库中查询的表名。</li>
<li><strong>多语言支持</strong>：通过 <code>setMutilLangNameRef(true)</code> 说明参照支持多语言。</li>
</ul>
<p>主要作用</p>
<ul>
<li>定义当前参照的元数据，包括参照表的名称、参照字段（编码、名称、主键）以及是否支持多语言。</li>
<li>通过 <code>getRefMeta()</code> 返回 <code>RefMeta</code>，为 <code>DefaultGridRefAction</code> 的核心查询逻辑提供必要的元数据信息。</li>
<li>配置数据权限控制和是否显示被停用数据等业务规则（如 <code>setResourceCode</code> 和 <code>setShowDisabledData</code>）。</li>
</ul>
</li>
</ul>
<p>​	   <code>RefMeta</code> 存储的数据示例：</p>
<blockquote>
<p>Code Field: code</p>
<p>Name Field: name</p>
<p>PK Field: pk_vtax_tax_hws_service</p>
<p>Table Name: vtax_tax_hws_service</p>
<p>Multi-language Support: true			</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/05/67297121e782e.png" alt="ncc24.png"></p>
<p>  10.2<code>DefaultGridRefAction</code></p>
<ul>
<li><code>DefaultGridRefAction</code> 是一个抽象类，继承自 <code>AbstractRefAction</code>，它为表格参照功能提供了默认的实现。<code>DefaultGridRefAction</code> 中定义了参照功能的几个核心方法，帮助处理参照的查询逻辑，尤其是通过 <code>processData()</code> 方法完成对数据的查询与处理。</li>
<li><code>NCGridRefDBProcessor</code> 是负责实际数据库查询的处理器，它结合 <code>RefMeta</code> 和 <code>IRefSqlBuilder</code> 生成 SQL 语句，执行查询，并将结果封装成 <code>RefRow[]</code> 和 <code>RefQueryResult</code>。</li>
<li><code>getRefMeta()</code>：返回 <code>RefMeta</code> 对象，定义参照功能的数据结构，如字段、表名等。</li>
<li><code>processData()</code>：<code>processData()</code> 方法是整个数据查询的核心步骤，它负责通过 <code>TreeRefQueryInfo</code> 进行 SQL 查询构造，执行查询，处理主键与字段数据，最后返回一个查询结果集。</li>
<li>职责：<ul>
<li>执行查询逻辑：根据 <code>Tax_hws_serviceDefaultGridRefAction</code> 中返回的 <code>RefMeta</code>，以及前端传递的查询条件，生成 SQL 查询，并执行查询。</li>
<li>数据处理：通过数据库处理器（<code>NCGridRefDBProcessor</code>）进行主键查询、字段查询，并进一步处理查询出的数据。</li>
<li>返回查询结果：最终将处理后的参照数据封装为 <code>RefQueryResult</code> 对象，返回给前端。</li>
</ul>
</li>
<li><strong>DefaultGridRefAction.java（核心处理逻辑类）</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">DefaultGridRefAction</span> <span class="keyword">extends</span> <span class="title class_">AbstractRefAction</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DefaultGridRefAction</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> RefMeta <span class="title function_">getRefMeta</span><span class="params">(RefQueryInfo var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initPageInfo</span><span class="params">(PageInfo pageInfo)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> RefQueryResult <span class="title function_">processData</span><span class="params">(TreeRefQueryInfo refQueryInfo)</span> &#123;</span><br><span class="line">        <span class="comment">//1.获取SQL构造器</span></span><br><span class="line">        <span class="comment">//IRefSqlBuilder 是一个接口，负责生成 SQL 查询语句。</span></span><br><span class="line">        <span class="comment">//在这里，我们通过 getRefSqlBuilder(refQueryInfo) 方法获取 SQL 构造器。</span></span><br><span class="line">        <span class="comment">//refQueryInfo 对象包含了前端传递的查询条件（如关键字、分页信息、过滤条件）</span></span><br><span class="line">        <span class="comment">//这些条件会用于生成 SQL 查询。</span></span><br><span class="line">        <span class="comment">//refSqlBuilder通过 RefQueryInfo 的数据生成最终执行的 SQL 查询语句</span></span><br><span class="line">        <span class="comment">//处理条件拼接、排序等复杂的 SQL 操作。</span></span><br><span class="line">        <span class="type">IRefSqlBuilder</span> <span class="variable">refSqlBuilder</span> <span class="operator">=</span> <span class="built_in">this</span>.getRefSqlBuilder(refQueryInfo);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">//2.初始化处理器</span></span><br><span class="line">        <span class="comment">//NCGridRefDBProcessor 是一个用于执行数据库查询的处理器。</span></span><br><span class="line">        <span class="comment">//它会结合 RefMeta（元数据）和 IRefSqlBuilder 生成查询。</span></span><br><span class="line">        <span class="comment">//this.getRefMeta(refQueryInfo)：调用会返回当前参照的元数据信息（如字段名、主键、表名等)用于SQL生成</span></span><br><span class="line">        <span class="comment">//refSqlBuilder 用于构造 SQL 查询的实际语句:</span></span><br><span class="line">        <span class="comment">//通过将 RefMeta 和 IRefSqlBuilder 传入，处理器能够构建出最终要执行的 SQL 查询。</span></span><br><span class="line">        <span class="type">NCGridRefDBProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NCGridRefDBProcessor</span>(<span class="built_in">this</span>.getRefMeta(refQueryInfo), refSqlBuilder);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">//3.根据条件查询参照主键</span></span><br><span class="line">        <span class="comment">//理器通过调用 queryRefPks() 方法，根据 refQueryInfo 中的条件，查询参照数据的主键（PK）。</span></span><br><span class="line">        <span class="comment">//queryRefPks() 返回一个主键数组 strQueryRefPks。</span></span><br><span class="line">        <span class="comment">//表示数据库中符合查询条件的记录的主键值。</span></span><br><span class="line">        String[] strQueryRefPks = processor.queryRefPks(refQueryInfo);</span><br><span class="line">       </span><br><span class="line">        <span class="comment">//4.处理查询出的参照主键</span></span><br><span class="line">        <span class="comment">//通过调用 processRefPks() 方法，进一步处理查询出来的主键（参照过滤，处理特定的业务逻辑）</span></span><br><span class="line">        <span class="comment">//处理完之后，返回一个更新后的主键数组 strQueryRefPks。</span></span><br><span class="line">        strQueryRefPks = <span class="built_in">this</span>.processRefPks(refQueryInfo, refSqlBuilder, strQueryRefPks);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//5.根据主键查询所有所需的字段</span></span><br><span class="line">        <span class="comment">//通过主键数组 strQueryRefPks，调用 processor.getRowsByPks()，从数据库中查询每条记录的所有字段信息。</span></span><br><span class="line">        <span class="comment">//返回值是一个 RefRow[] 数组</span></span><br><span class="line">        <span class="comment">//每个 RefRow 代表一个查询结果的行，包含所有所需的字段（如 code，name，pk 等）。</span></span><br><span class="line">        RefRow[] refRows = processor.getRowsByPks(strQueryRefPks);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//6.处理最后查询出的结果集</span></span><br><span class="line">        <span class="comment">//进一步处理查询出的数据行，类似于处理主键的步骤。</span></span><br><span class="line">        <span class="comment">//对数据行进行额外的处理或过滤，比如多语言处理、字段格式化等。</span></span><br><span class="line">        <span class="comment">//处理完成回，返回一个refRows数组</span></span><br><span class="line">        refRows = <span class="built_in">this</span>.processRefRows(refQueryInfo, refSqlBuilder, refRows);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//7.构造返回结果，返回数据</span></span><br><span class="line">        <span class="comment">//调用 processor.constructResult() 方法，将处理过的 RefRow[] 和分页信息打包成一个 RefQueryResult 对象。</span></span><br><span class="line">        <span class="comment">//refQueryResult 是最终返回给前端的数据结构，包含了查询的结果集和分页信息。</span></span><br><span class="line">        <span class="type">RefQueryResult</span> <span class="variable">refQueryResult</span> <span class="operator">=</span> processor.constructResult(refRows, refQueryInfo);</span><br><span class="line">        <span class="keyword">return</span> refQueryResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  10.3 <strong><code>AbstractRefAction.java</code></strong></p>
<ul>
<li><code>AbstractRefAction</code> 提供了很多参照功能中的基础逻辑，如数据权限、多语言处理、SQL 构建等。它通过接口 <code>IRefSqlBuilder</code> 实现 SQL 查询构建，并为参照功能提供了灵活的扩展接口。</li>
<li><code>DefaultRefSqlBuilder</code> 会使用 <code>RefQueryInfo</code> 中存储的条件，包括组织、集团 ID 和其他过滤条件，这些都是由入口类或 <code>AbstractRefAction</code> 设置的。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 抽象的引用动作类，继承了NCCAction并实现了IRefSqlBuilder接口，负责数据引用查询的操作</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractRefAction</span> <span class="keyword">extends</span> <span class="title class_">NCCAction</span> <span class="keyword">implements</span> <span class="title class_">IRefSqlBuilder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">blShowDisabledData</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//控制是否展示被停用的数据</span></span><br><span class="line">    <span class="keyword">private</span> String strDataPowerColumn;<span class="comment">//负责数据权限的字段。系统可以根据用户角色或组织权限来过滤参照数据。</span></span><br><span class="line">    <span class="keyword">private</span> String strMdClassId;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">strUnitPkKey</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">strUsualDataPkFieldName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">strUsualDataTableName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//无参构造</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbstractRefAction</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行引用查询操作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request 请求对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> para 查询参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 查询结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Object <span class="title function_">execute</span><span class="params">(IRequest request, T para)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 将通用参数 para 转换为 TreeRefQueryInfo，从而可以访问参照数据特定的查询条件 queryCondition。</span></span><br><span class="line">        <span class="type">TreeRefQueryInfo</span> <span class="variable">refQueryInfo</span> <span class="operator">=</span> (TreeRefQueryInfo) para;</span><br><span class="line">        Map&lt;String, String&gt; queryCondition = refQueryInfo.getQueryCondition();</span><br><span class="line">        <span class="comment">// 判断是否显示常用数据：通过 isShowUsual 判断用户是否选择了查看常用数据（即常用参照）。</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isShowUsual</span> <span class="operator">=</span> UFBoolean.valueOf(queryCondition.get(<span class="string">&quot;isShowUsual&quot;</span>)).booleanValue();</span><br><span class="line">        <span class="comment">// 如果显示常用数据.开始构建常用参照的SQL</span></span><br><span class="line">        <span class="keyword">if</span> (isShowUsual) &#123;</span><br><span class="line">            <span class="comment">// 系统会使用 UsualRefSqlBuilder，以便构建常用参照的 SQL 查询。</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">strUsualGridRefActionExt</span> <span class="operator">=</span> queryCondition.get(<span class="string">&quot;UsualGridRefActionExt&quot;</span>);</span><br><span class="line">            strUsualGridRefActionExt = StringUtils.isBlank(strUsualGridRefActionExt)</span><br><span class="line">                    ? UsualRefSqlBuilder.class.getName()</span><br><span class="line">                    : strUsualGridRefActionExt + <span class="string">&quot;,&quot;</span> + UsualRefSqlBuilder.class.getName(); </span><br><span class="line">            <span class="comment">// 确保常用数据查询能使用适当的 SQL 构建规则。</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">gridRefActionExts</span> <span class="operator">=</span> queryCondition.get(<span class="string">&quot;GridRefActionExt&quot;</span>);</span><br><span class="line">            gridRefActionExts = StringUtils.isBlank(gridRefActionExts)</span><br><span class="line">                    ? strUsualGridRefActionExt</span><br><span class="line">                    : gridRefActionExts + <span class="string">&quot;,&quot;</span> + strUsualGridRefActionExt;</span><br><span class="line">            queryCondition.put(<span class="string">&quot;GridRefActionExt&quot;</span>, gridRefActionExts);</span><br><span class="line">            <span class="comment">// 设置单位主键（组织过滤）</span></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(<span class="built_in">this</span>.getQueryValue(refQueryInfo, <span class="string">&quot;unitPks&quot;</span>))) &#123;</span><br><span class="line">                <span class="built_in">this</span>.setQueryValue(refQueryInfo, <span class="string">&quot;unitPks&quot;</span>, <span class="built_in">this</span>.getPk_org(refQueryInfo));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.initPageInfo(refQueryInfo.getPageInfo());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.initUnitPk(refQueryInfo, <span class="built_in">this</span>.getKeyUnitPks());</span><br><span class="line">        <span class="comment">// 系统调用 processData() 方法执行具体的参照数据查询</span></span><br><span class="line">        <span class="comment">// 并返回查询结果 RefQueryResult，该对象包含查询后的数据和分页信息。</span></span><br><span class="line">        <span class="type">RefQueryResult</span> <span class="variable">refQueryResult</span> <span class="operator">=</span> <span class="built_in">this</span>.processData(refQueryInfo);</span><br><span class="line">        <span class="keyword">return</span> refQueryResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取额外的SQL条件，拼接Sql语句中where 后的条件语句</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getExtraSql</span><span class="params">(RefQueryInfo refQueryInfo, RefMeta refMeta)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取额外的SQL参数,设置where后条件语句中占位符对应的真实数据（为了防止Sql注入）</span></span><br><span class="line">    <span class="keyword">public</span> SqlParameterCollection <span class="title function_">getExtraSqlParameter</span><span class="params">(RefQueryInfo refQueryInfo, RefMeta refMeta)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// getPk_org() 和 getPk_group() 提供了数据权限控制的组织和集团过滤条件。</span></span><br><span class="line">    <span class="comment">// 入口类通过 setQueryValue() 方法将这些组织、集团 ID 作为条件传入 RefQueryInfo</span></span><br><span class="line">    <span class="comment">// 确保只有当前用户所属的组织和集团数据可以被查询到。</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPk_org</span><span class="params">(RefQueryInfo refQueryInfo)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">strPk_org</span> <span class="operator">=</span> <span class="built_in">this</span>.getQueryValue(refQueryInfo, <span class="string">&quot;pk_org&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> StringUtils.isBlank(strPk_org) ? <span class="built_in">this</span>.getPk_group(refQueryInfo) : strPk_org;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPk_group</span><span class="params">(RefQueryInfo refQueryInfo)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">strPk_group_session</span> <span class="operator">=</span> SessionContext.getInstance().getClientInfo().getPk_group();</span><br><span class="line">    <span class="keyword">if</span> (refQueryInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> strPk_group_session;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">strPk_group2</span> <span class="operator">=</span> <span class="built_in">this</span>.getQueryValue(refQueryInfo, <span class="string">&quot;pk_group&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> StringUtils.isBlank(strPk_group2) ? strPk_group_session : strPk_group2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取SQL构建器</span></span><br><span class="line">    <span class="comment">// 这是一个工厂方法，返回 SQL 构造器</span></span><br><span class="line">    <span class="comment">// DefaultRefSqlBuilder 负责根据 RefQueryInfo 构建 SQL 查询语句。</span></span><br><span class="line">    <span class="keyword">protected</span> IRefSqlBuilder <span class="title function_">getRefSqlBuilder</span><span class="params">(RefQueryInfo refQueryInfo)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultRefSqlBuilder</span>(<span class="built_in">this</span>, <span class="built_in">this</span>, refQueryInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 多语言翻译处理</span></span><br><span class="line">    <span class="comment">// 通过 RefVO_mlang 中的多语言配置，设置不同语言的显示值，保证参照名称在不同语言环境下能正确展示。</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processMultiLang</span><span class="params">(RefQueryInfo refQueryInfo, RefRow refRow)</span> &#123;</span><br><span class="line">        RefVO_mlang[] multiLangRefVOs = <span class="built_in">this</span>.getMultiLangRefVO();</span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.isEmpty(multiLangRefVOs)) &#123;</span><br><span class="line">            Map&lt;String, Cell&gt; mapRowValues = refRow.getValues();</span><br><span class="line">            <span class="keyword">for</span> (RefVO_mlang mlRefVO : multiLangRefVOs) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">strResId</span> <span class="operator">=</span> mlRefVO.getPreStr();</span><br><span class="line">                String[] strResIdFieldNames = mlRefVO.getResIDFieldNames();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!ArrayUtils.isEmpty(strResIdFieldNames)) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (String fieldName : strResIdFieldNames) &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">objValue</span> <span class="operator">=</span> mapRowValues.get(fieldName).getValue();</span><br><span class="line">                        <span class="keyword">if</span> (objValue != <span class="literal">null</span>) &#123;</span><br><span class="line">                            strResId += objValue.toString();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">Object</span> <span class="variable">objFieldValue</span> <span class="operator">=</span> mapRowValues.get(mlRefVO.getFieldName()).getValue();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">strDirName</span> <span class="operator">=</span> mlRefVO.getDirName();</span><br><span class="line">                    <span class="keyword">if</span> (mlRefVO.getDirFieldName() != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">objDirFieldName</span> <span class="operator">=</span> mapRowValues.get(mlRefVO.getDirFieldName()).getValue();</span><br><span class="line">                        <span class="keyword">if</span> (objDirFieldName != <span class="literal">null</span>) &#123;</span><br><span class="line">                            strDirName = objDirFieldName.toString();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">String</span> <span class="variable">strFieldValue</span> <span class="operator">=</span> objFieldValue == <span class="literal">null</span> ? <span class="literal">null</span> : objFieldValue.toString();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">strMultiLang</span> <span class="operator">=</span> <span class="built_in">this</span>.getMultiLangResource(strDirName, strFieldValue, strResId);</span><br><span class="line">                    mapRowValues.get(mlRefVO.getFieldName()).setValue(strMultiLang);</span><br><span class="line"></span><br><span class="line">                    <span class="type">RefMeta</span> <span class="variable">refMeta</span> <span class="operator">=</span> <span class="built_in">this</span>.getRefMeta(refQueryInfo);</span><br><span class="line">                    <span class="keyword">if</span> (refMeta != <span class="literal">null</span> &amp;&amp; ObjectUtils.equals(refMeta.getNameField(), mlRefVO.getFieldName())) &#123;</span><br><span class="line">                        refRow.setRefname(strMultiLang);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于枚举值的多语言处理。对于枚举类型的字段</span></span><br><span class="line">    <span class="comment">//系统通过多语言映射表返回相应语言的值，确保参照数据中的枚举字段多语言化。</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processMultiLangForEnum</span><span class="params">(RefQueryInfo refQueryInfo, RefRow refRow)</span> &#123;</span><br><span class="line">        Map&lt;String, Map&lt;String, String&gt;&gt; mapRes = <span class="built_in">this</span>.getMultiLangForEnum();</span><br><span class="line">        <span class="keyword">if</span> (!MapUtils.isEmpty(mapRes)) &#123;</span><br><span class="line">            Map&lt;String, Cell&gt; mapRowValues = refRow.getValues();</span><br><span class="line">            <span class="keyword">for</span> (String strEnumFieldName : mapRes.keySet()) &#123;</span><br><span class="line">                <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> mapRowValues.get(strEnumFieldName);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">objFieldValue</span> <span class="operator">=</span> cell.getValue();</span><br><span class="line">                <span class="type">String</span> <span class="variable">strMultiLang</span> <span class="operator">=</span> mapRes.get(strEnumFieldName).get(objFieldValue);</span><br><span class="line">                cell.setValue(strMultiLang);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//processRefPks() 和 processRefRows() 方法</span></span><br><span class="line">    <span class="comment">//会进一步调用 AbstractRefAction 的权限和多语言处理逻辑。</span></span><br><span class="line">    <span class="keyword">protected</span> String[] processRefPks(RefQueryInfo refQueryInfo, IRefSqlBuilder refSqlBuilder, String... strQueryRefPks) &#123;</span><br><span class="line">        <span class="keyword">return</span> strQueryRefPks;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> RefRow[] processRefRows(RefQueryInfo refQueryInfo, IRefSqlBuilder refSqlBuilder, RefRow... refRows) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.isEmpty(refRows)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (RefRow refRow : refRows) &#123;</span><br><span class="line">                <span class="comment">// 多语言处理</span></span><br><span class="line">                <span class="built_in">this</span>.processMultiLang(refQueryInfo, refRow); </span><br><span class="line">                <span class="built_in">this</span>.processMultiLangForEnum(refQueryInfo, refRow);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> refRows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  10.4<code>NCCAction</code></p>
<ul>
<li><code>NCCAction</code> 是一个抽象基础类，定义了通用的操作流程和错误处理机制，为具体的业务逻辑类（例如参照功能类）提供支持。</li>
<li><code>NCCAction</code> 提供了执行业务操作的通用流程，并定义了 <code>doAction()</code> 方法，作为所有具体操作类的执行入口。在参照功能中，这个类的主要作用包括以下几方面：<ul>
<li><strong>标准化的操作流程</strong>：<code>doAction()</code> 定义了操作执行的通用流程，包含参数获取（<code>getPara</code>）、预处理（<code>doBeforeAction</code>）、实际执行（<code>execute</code>）、后处理（<code>doAfterSuccess</code>）和异常处理（<code>handleException</code>）。</li>
<li><strong>权限校验</strong>：<code>checkDataPermission()</code> 方法用于数据权限校验，确保只有符合权限的数据可以被访问。</li>
<li><strong>异常处理</strong>：<code>handleException()</code> 和 <code>handleBusinessException()</code> 处理不同类型的异常，确保系统稳定运行，并将合适的错误信息返回给用户。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NCCAction 是一个抽象类，提供了处理 Web 请求的标准化流程。</span></span><br><span class="line"><span class="comment">//该类实现了一个ICommonAction接口，包含请求参数处理、操作执行和异常处理等核心逻辑</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">NCCAction</span> <span class="keyword">implements</span> <span class="title class_">ICommonAction</span> &#123;</span><br><span class="line">    <span class="comment">//用来存储操作码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">strMdOperateCode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">strOperateCode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">strResourceCode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//默认构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NCCAction</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查数据权限，确保用户可以执行该操作</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">checkDataPermission</span><span class="params">(IRequest request, Object objData)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DataPermissionAction</span> <span class="variable">dataPermissionAction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataPermissionAction</span>();</span><br><span class="line">        <span class="type">ValidationException</span> <span class="variable">validException</span> <span class="operator">=</span> dataPermissionAction.checkDataPermission(<span class="built_in">this</span>.getResourceCode(), <span class="built_in">this</span>.getMdOperateCode(), <span class="built_in">this</span>.getOperateCode(), objData);</span><br><span class="line">        dataPermissionAction.dealValidationException(validException);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//核心方法，处理请求，执行制定操作</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">doAction</span><span class="params">(IRequest request)</span> &#123;</span><br><span class="line">        Logger.debug(<span class="string">&quot;begin action--&gt;&quot;</span> + <span class="built_in">this</span>.getClass().getName() + <span class="string">&quot;.doAction()&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">para</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//存储解析后的请求参数</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//存储操作执行后的结果</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取请求参数</span></span><br><span class="line">            para = <span class="built_in">this</span>.getPara(request, <span class="built_in">this</span>.getParaClass());</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.doBeforeAction(request, para)) &#123;</span><br><span class="line">                <span class="comment">//执行前的预处理，如果失败就返回</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">var10</span> <span class="operator">=</span> result;</span><br><span class="line">                <span class="keyword">return</span> var10;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//执行核心逻辑</span></span><br><span class="line">            result = <span class="built_in">this</span>.execute(request, para);</span><br><span class="line">            <span class="built_in">this</span>.doAfterSuccess(request, para);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">            <span class="type">Exception</span> <span class="variable">ex</span> <span class="operator">=</span> var8;</span><br><span class="line">            <span class="built_in">this</span>.doAfterFailure(request, para);<span class="comment">//操作失败后的处理</span></span><br><span class="line">            <span class="built_in">this</span>.handleException(ex);<span class="comment">//异常处理</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Logger.debug(<span class="string">&quot;end action--&gt;&quot;</span> + <span class="built_in">this</span>.getClass().getName() + <span class="string">&quot;.doAction()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;<span class="comment">//返回执行结果</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在操作失败后，提供子类重写</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">doAfterFailure</span><span class="params">(IRequest request, T para)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在操作成功后，提供子类重写</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">doAfterSuccess</span><span class="params">(IRequest request, T para)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//操作执行前的预处理，默认返回值true，允许操作执行，子类可重写</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="type">boolean</span> <span class="title function_">doBeforeAction</span><span class="params">(IRequest request, T para)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//抽象方法，子类必须实现这个方法用于定义具体操作的执行逻辑</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;T&gt; Object <span class="title function_">execute</span><span class="params">(IRequest var1, T var2)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//getter方法</span></span><br><span class="line">    <span class="comment">//获取 MdOperateCode</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getMdOperateCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.strMdOperateCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 OperateCode</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getOperateCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.strOperateCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从请求中获取参数并转换为指定类型的对象</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getPara</span><span class="params">(IRequest request, Class paraClass)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">strRead</span> <span class="operator">=</span> request.read();</span><br><span class="line">        <span class="type">T</span> <span class="variable">para</span> <span class="operator">=</span> JsonFactory.create().fromJson(strRead, paraClass);</span><br><span class="line">        <span class="keyword">return</span> para;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 获取参数类型，默认返回 HashMap.class</span></span><br><span class="line">    <span class="keyword">protected</span> Class <span class="title function_">getParaClass</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> HashMap.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 获取 ResourceCode</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getResourceCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.strResourceCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理业务异常，根据不同类型的异常返回相应的错误信息</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleBusinessException</span><span class="params">(BusinessException ex)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">strMsg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BizLockFailedException) &#123;</span><br><span class="line">            strMsg = NCLangRes4VoTransl.getNCLangRes().getStrByID(<span class="string">&quot;uif2&quot;</span>, <span class="string">&quot;DefaultExceptionHanler-000004&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> LockFailedException) &#123;</span><br><span class="line">            strMsg = NCLangRes4VoTransl.getNCLangRes().getStrByID(<span class="string">&quot;uif2&quot;</span>, <span class="string">&quot;DefaultExceptionHanler-000000&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ValidationException) &#123;</span><br><span class="line">            strMsg = ((ValidationException)ex).getMessage();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> VersionConflictException) &#123;</span><br><span class="line">            strMsg = NCLangRes4VoTransl.getNCLangRes().getStrByID(<span class="string">&quot;uif2&quot;</span>, <span class="string">&quot;DefaultExceptionHanler-000002&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            strMsg = ex.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ExceptionUtils.wrapBusinessException(strMsg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理不同类型的异常</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleException</span><span class="params">(Exception ex)</span> &#123;</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">ex2</span> <span class="operator">=</span> ExceptionUtils.unmarsh(ex);</span><br><span class="line">        Logger.error(<span class="string">&quot;**************************************************** NCCAction Error ****************************************************&quot;</span>);</span><br><span class="line">        Logger.error(ex2.getMessage(), ex);</span><br><span class="line">        <span class="keyword">if</span> (ex2 <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleRuntimeException((RuntimeException)ex2);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex2 <span class="keyword">instanceof</span> BusinessException) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleBusinessException((BusinessException)ex2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleUnknownException(ex2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//处理运行时异常</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleRuntimeException</span><span class="params">(RuntimeException ex)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> FrameworkSecurityException) &#123;</span><br><span class="line">            ExceptionUtils.wrapBusinessException(NCLangRes4VoTransl.getNCLangRes().getStrByID(<span class="string">&quot;uif2&quot;</span>, <span class="string">&quot;DefaultExceptionHanler-000006&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BusinessExceptionAdapter) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleBusinessException(((BusinessExceptionAdapter)ex).originalException);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(ex <span class="keyword">instanceof</span> nccloud.base.exception.BusinessException) &amp;&amp; !(ex <span class="keyword">instanceof</span> nccloud.framework.core.exception.BusinessException)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleUnknownException(ex);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleUnknownException(ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//处理未知异常</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleUnknownException</span><span class="params">(Throwable ex)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">strMsg</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(strMsg)) &#123;</span><br><span class="line">            strMsg = NCLangRes4VoTransl.getNCLangRes().getStrByID(<span class="string">&quot;uif2&quot;</span>, <span class="string">&quot;DefaultExceptionHanler-000001&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">BusinessException</span> <span class="variable">business</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(strMsg);</span><br><span class="line">        business.setStackTrace(ex.getStackTrace());</span><br><span class="line">        ExceptionUtils.wrapException(business);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//setter方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMdOperateCode</span><span class="params">(String mdOperateCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.strMdOperateCode = mdOperateCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOperateCode</span><span class="params">(String operateCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.strOperateCode = operateCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResourceCode</span><span class="params">(String resourceCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.strResourceCode = resourceCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  10.5 <code>NCGridRefDBProcessor</code></p>
<ul>
<li><code>NCGridRefDBProcessor</code>  是参照功能中具体负责执行数据库操作的核心类，它处理参照数据的查询、结果处理等功能。<ul>
<li>这个类的主要任务是通过与 <code>RefMeta</code> 和 <code>RefQueryInfo</code> 协作，生成 SQL 查询语句并执行它，最终返回参照数据。这类的主要方法包括 <code>queryRefPks()</code>、<code>getRowsByPks()</code> 和 <code>constructResult()</code></li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据用户输入的查询条件（如关键字、过滤条件等），生成查询主键的 SQL 语句并执行，返回符合条件的主键数组。</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">String</span>[] <span class="title function_">queryRefPks</span>(<span class="params"><span class="title class_">RefQueryInfo</span> para</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">refQueryInfo</span> = para;</span><br><span class="line">  <span class="title class_">PageInfo</span> page = para.<span class="title function_">getPageInfo</span>();</span><br><span class="line">  <span class="title class_">String</span>[] pks = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 判断是否进行全文检索</span></span><br><span class="line">  <span class="comment">// 如果需要全文检索,通过 qryByFulltxt()方法生成基于关键字的查询结果。</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">getFulTxtFlg</span>(para)) &#123;</span><br><span class="line">    pks = <span class="variable language_">this</span>.<span class="title function_">qryByFulltxt</span>(para);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 非全文检索</span></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 系统会根据分页信息来决定是查询所有主键（调用 queryAll()）,</span></span><br><span class="line">    <span class="comment">// 还是根据分页信息分段查询（调用 queryByPage()）。</span></span><br><span class="line">    <span class="comment">// 当前页码为-1时查全部数据</span></span><br><span class="line">    <span class="keyword">if</span> (page.<span class="title function_">getPageIndex</span>() == -<span class="number">1</span>) &#123;</span><br><span class="line">      pks = <span class="variable language_">this</span>.<span class="title function_">queryAll</span>(para);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 根据分页信息分段查询</span></span><br><span class="line">      pks = <span class="variable language_">this</span>.<span class="title function_">queryByPage</span>(para, page);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pks; <span class="comment">// 返回查询到的主键</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setMaxRows</span>(<span class="params">int maxRows</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">maxRows</span> = maxRows; <span class="comment">// 设置最大行数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成查询主键的 SQL 语句，用于从数据库中获取符合条件的主键数据。</span></span><br><span class="line"><span class="comment">// 根据 RefMeta 中定义的表名和主键字段，生成基础 SQL 查询。</span></span><br><span class="line"><span class="comment">// 如果查询条件中有搜索主键（SearchPks），系统会根据主键来过滤。</span></span><br><span class="line"><span class="comment">// getWhereSql() 和 getOrderSql() 方法分别用于生成 WHERE 条件和 ORDER BY 排序。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  RefMeta（参照数据结构定义）和 RefQueryInfo（用户查询条件）</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getQueryIDSql</span>(<span class="params"><span class="title class_">RefQueryInfo</span> para</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">refQueryInfo</span> = para;    </span><br><span class="line">    <span class="comment">// 构建基础 SQL 查询</span></span><br><span class="line">    <span class="title class_">StringBuilder</span> sb = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="comment">// this.refMeta.getPkField() 参照主键</span></span><br><span class="line">    <span class="comment">// this.refMeta.getTableName() 参照表名</span></span><br><span class="line">    sb.<span class="title function_">append</span>(<span class="string">&quot; select &quot;</span>).<span class="title function_">append</span>(<span class="variable language_">this</span>.<span class="property">refMeta</span>.<span class="title function_">getPkField</span>()).<span class="title function_">append</span>(<span class="string">&quot; from &quot;</span>).<span class="title function_">append</span>(<span class="variable language_">this</span>.<span class="property">refMeta</span>.<span class="title function_">getTableName</span>());</span><br><span class="line">    sb.<span class="title function_">append</span>(<span class="string">&quot; where 1 = 1 &quot;</span>);</span><br><span class="line">    <span class="comment">// 如果有搜索主键，添加过滤条件</span></span><br><span class="line">    <span class="keyword">if</span> (para.<span class="title function_">getSearchPks</span>() != <span class="literal">null</span> &amp;&amp; para.<span class="title function_">getSearchPks</span>().<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        sb.<span class="title function_">append</span>(<span class="string">&quot; and &quot;</span>).<span class="title function_">append</span>(<span class="variable language_">this</span>.<span class="property">refMeta</span>.<span class="title function_">getPkField</span>()).<span class="title function_">append</span>(<span class="string">&quot; in (&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">String</span> pk : para.<span class="title function_">getSearchPks</span>()) &#123;</span><br><span class="line">            sb.<span class="title function_">append</span>(<span class="string">&quot;&#x27;&quot;</span>).<span class="title function_">append</span>(pk).<span class="title function_">append</span>(<span class="string">&quot;&#x27;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sb.<span class="title function_">deleteCharAt</span>(sb.<span class="title function_">length</span>() - <span class="number">1</span>); <span class="comment">// 删除最后一个逗号</span></span><br><span class="line">        sb.<span class="title function_">append</span>(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// 生成 WHERE 条件和排序条件</span></span><br><span class="line">    sb.<span class="title function_">append</span>(<span class="variable language_">this</span>.<span class="title function_">getWhereSql</span>(para));</span><br><span class="line">    sb.<span class="title function_">append</span>(<span class="variable language_">this</span>.<span class="title function_">getOrderSql</span>(para));    </span><br><span class="line">    <span class="keyword">return</span> sb.<span class="title function_">toString</span>(); <span class="comment">// 返回生成的 SQL 查询语句</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据主键数组查询对应的参照数据行，并将数据封装为 RefRow[] 返回。</span></span><br><span class="line"><span class="comment">// 首先根据 pks 数组构建 SQL 查询，通过 IMultiNCGridRefRowService 查询数据库中的实际数据。</span></span><br><span class="line"><span class="comment">// 查询结果为 NCRefRow[] 格式，然后系统会将其转换为前端展示的 RefRow[] 格式，方便前端展示。</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">RefRow</span>[] <span class="title function_">getRowsByPks</span>(<span class="params"><span class="title class_">String</span>[] pks</span>) &#123;</span><br><span class="line">    <span class="comment">// IMultiNCGridRefRowService：通过这个服务对象调用数据库.</span></span><br><span class="line">    <span class="comment">// 执行根据主键过滤的 SQL 查询，并返回数据库中存储的参照数据行。</span></span><br><span class="line">    <span class="title class_">IMultiNCGridRefRowService</span> service = <span class="title class_">ServiceLocator</span>.<span class="title function_">find</span>(<span class="title class_">IMultiNCGridRefRowService</span>.<span class="property">class</span>);</span><br><span class="line">    <span class="title class_">SqlParameterCollection</span> collection = <span class="variable language_">this</span>.<span class="title function_">getSqlParameterCollection</span>(<span class="variable language_">this</span>.<span class="property">refQueryInfo</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据主键查询具体的数据行,RefRow 是适合前端展示的数据格式，包含了参照的code、name、pk等信息。</span></span><br><span class="line">    <span class="title class_">NCRefRow</span>[] rows = service.<span class="title function_">getRowsByPksAndWheresql</span>(<span class="variable language_">this</span>.<span class="title function_">getMeta</span>(), pks, <span class="variable language_">this</span>.<span class="property">wheresql</span>, collection);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将 NCRefRow 转换为 RefRow（供前端使用的数据格式）</span></span><br><span class="line">    <span class="title class_">RefRow</span>[] ret = <span class="variable language_">this</span>.<span class="title function_">convert</span>(rows);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将查询结果封装为 RefQueryResult 对象，并处理分页信息，将其返回给调用者。</span></span><br><span class="line"><span class="comment">// 根据 RefRow[] 数据，计算分页信息并构建返回的结果。</span></span><br><span class="line"><span class="comment">// 通过 PageInfo 来设置分页总页数和当前页的信息。</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">RefQueryResult</span> <span class="title function_">constructResult</span>(<span class="params"><span class="title class_">RefRow</span>[] rows, <span class="title class_">RefQueryInfo</span> para</span>) &#123;</span><br><span class="line">  <span class="comment">// 创建查询结果对象</span></span><br><span class="line">  <span class="title class_">RefQueryResult</span> result = <span class="keyword">new</span> <span class="title class_">RefQueryResult</span>();</span><br><span class="line">  <span class="comment">// 设置查询结果中的行数据</span></span><br><span class="line">  result.<span class="title function_">setRows</span>(rows);</span><br><span class="line">  <span class="comment">// 获取查询参数中的分页信息</span></span><br><span class="line">  <span class="title class_">PageInfo</span> page = para.<span class="title function_">getPageInfo</span>();</span><br><span class="line">  <span class="comment">// 计算总页数，确保至少有一页</span></span><br><span class="line">  <span class="comment">// 根据总记录数 this.total 和每页记录数 page.getPageSize() 计算总页数</span></span><br><span class="line">  int totalPageNum =</span><br><span class="line">      (<span class="variable language_">this</span>.<span class="property">total</span> + page.<span class="title function_">getPageSize</span>() - <span class="number">1</span>) / page.<span class="title function_">getPageSize</span>();</span><br><span class="line">  <span class="comment">// 设置分页信息中的总页数</span></span><br><span class="line">  page.<span class="title function_">setTotalPage</span>(totalPageNum);</span><br><span class="line">  <span class="comment">// 设置查询结果中的分页信息</span></span><br><span class="line">  result.<span class="title function_">setPage</span>(page);</span><br><span class="line">  <span class="comment">// RefQueryResult 是最终返回给调用者的数据对象，它包含了查询的行数据（RefRow[]）以及分页信息（PageInfo）。</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code> 整个参照流程包括前端发送查询条件、后端接收和解析条件、生成 SQL 查询并执行数据库查询、数据权限和多语言处理、最终将结果返回前端并展示。在这一过程中，涉及多类协同工作，确保查询高效、灵活，同时满足权限和多语言需求。
</code></pre>
<h1 id="具体流程"><a href="#具体流程" class="headerlink" title="具体流程"></a>具体流程</h1><h3 id="1-前端请求阶段"><a href="#1-前端请求阶段" class="headerlink" title="1. 前端请求阶段"></a>1. 前端请求阶段</h3><p>   用户在前端页面上操作，可能选择某个字段的参照功能（例如选择某个服务项目），页面会展示一个参照弹窗，允许用户根据关键字搜索、分页浏览或选择组织等条件过滤数据。用户输入的查询条件会通过 AJAX 请求或其他方式，发送到后端 API。</p>
<h3 id="2-后端接收请求并初始化查询"><a href="#2-后端接收请求并初始化查询" class="headerlink" title="2. 后端接收请求并初始化查询"></a>2. 后端接收请求并初始化查询</h3><h4 id="2-1-NCCAction-doAction-作为操作入口"><a href="#2-1-NCCAction-doAction-作为操作入口" class="headerlink" title="2.1 NCCAction.doAction() 作为操作入口"></a>2.1 <code>NCCAction.doAction()</code> 作为操作入口</h4><ul>
<li><code>NCCAction</code> 是后端接收请求的入口类，通过 <code>doAction()</code> 方法接收用户的查询请求。</li>
<li><code>doAction()</code> 调用 <code>getPara()</code> 方法读取并解析前端传来的查询条件，将其封装为 <code>RefQueryInfo</code> 对象，包含查询关键字、分页信息、过滤条件（如组织、主键过滤）等。</li>
</ul>
<h4 id="2-2-执行-AbstractRefAction-execute-处理查询条件"><a href="#2-2-执行-AbstractRefAction-execute-处理查询条件" class="headerlink" title="2.2 执行 AbstractRefAction.execute() 处理查询条件"></a>2.2 执行 <code>AbstractRefAction.execute()</code> 处理查询条件</h4><ul>
<li>在 <code>NCCAction</code> 中调用 <code>execute()</code> 方法，此时进入 <code>AbstractRefAction</code> 类中实现的 <code>execute()</code> 方法。</li>
<li><code>execute()</code> 方法负责解析 <code>RefQueryInfo</code> 中的查询条件：<ul>
<li>判断是否显示常用数据，如果是，则会附加 <code>UsualRefSqlBuilder</code> 的 SQL 构建逻辑。</li>
<li>检查并设置 <code>unitPks</code>（组织主键），为参照查询增加组织过滤。</li>
<li>初始化 <code>PageInfo</code>，用于分页显示数据。</li>
</ul>
</li>
<li>最终，<code>execute()</code> 方法调用 <code>processData()</code> 方法，正式进入参照数据的查询处理阶段。</li>
</ul>
<h3 id="3-数据查询和处理阶段"><a href="#3-数据查询和处理阶段" class="headerlink" title="3. 数据查询和处理阶段"></a>3. 数据查询和处理阶段</h3><h4 id="3-1-DefaultGridRefAction-processData-生成查询-SQL"><a href="#3-1-DefaultGridRefAction-processData-生成查询-SQL" class="headerlink" title="3.1 DefaultGridRefAction.processData() 生成查询 SQL"></a>3.1 <code>DefaultGridRefAction.processData()</code> 生成查询 SQL</h4><ul>
<li><code>processData()</code> 方法首先会获取 SQL 构建器 <code>IRefSqlBuilder</code>，该对象生成参照功能的 SQL 语句。</li>
<li><code>processData()</code> 负责生成查询 SQL，并调用数据库查询处理类 <code>NCGridRefDBProcessor</code> 执行查询。</li>
</ul>
<h4 id="3-2-NCGridRefDBProcessor-queryRefPks-查询符合条件的主键"><a href="#3-2-NCGridRefDBProcessor-queryRefPks-查询符合条件的主键" class="headerlink" title="3.2 NCGridRefDBProcessor.queryRefPks() 查询符合条件的主键"></a>3.2 <code>NCGridRefDBProcessor.queryRefPks()</code> 查询符合条件的主键</h4><ul>
<li>在 <code>NCGridRefDBProcessor</code> 中，<code>queryRefPks()</code> 方法会根据查询条件生成 SQL 语句：<ul>
<li>判断是否需要进行全文检索，如需要则调用 <code>qryByFulltxt()</code>，否则按页面分页信息决定调用 <code>queryAll()</code> 或 <code>queryByPage()</code>。</li>
</ul>
</li>
<li>执行查询后，<code>queryRefPks()</code> 返回符合条件的主键数组。</li>
</ul>
<h4 id="3-3-NCGridRefDBProcessor-getRowsByPks-查询参照数据行"><a href="#3-3-NCGridRefDBProcessor-getRowsByPks-查询参照数据行" class="headerlink" title="3.3 NCGridRefDBProcessor.getRowsByPks() 查询参照数据行"></a>3.3 <code>NCGridRefDBProcessor.getRowsByPks()</code> 查询参照数据行</h4><ul>
<li>根据 <code>queryRefPks()</code> 返回的主键数组，<code>getRowsByPks()</code> 会执行进一步的 SQL 查询，获取每条参照数据的完整行。</li>
<li>结果以 <code>NCRefRow[]</code> 的格式返回，其中包含了每一行的编码、名称、主键等字段信息。</li>
<li>系统会将 <code>NCRefRow[]</code> 转换为 <code>RefRow[]</code> 格式，这是前端更适合使用的数据格式。</li>
</ul>
<h4 id="3-4-NCGridRefDBProcessor-constructResult-封装结果"><a href="#3-4-NCGridRefDBProcessor-constructResult-封装结果" class="headerlink" title="3.4 NCGridRefDBProcessor.constructResult() 封装结果"></a>3.4 <code>NCGridRefDBProcessor.constructResult()</code> 封装结果</h4><ul>
<li><code>constructResult()</code> 方法将查询到的数据行 <code>RefRow[]</code> 封装为 <code>RefQueryResult</code> 对象。</li>
<li>它还会处理分页信息，如计算总页数，设置 <code>PageInfo</code> 等，确保数据分页返回符合用户请求。</li>
</ul>
<h3 id="4-数据权限、多语言处理阶段"><a href="#4-数据权限、多语言处理阶段" class="headerlink" title="4. 数据权限、多语言处理阶段"></a>4. 数据权限、多语言处理阶段</h3><p>   在 <code>processData()</code> 中，数据行会进一步经过权限控制和多语言处理，确保符合用户权限的控制要求。<code>processMultiLang()</code> 会处理多语言转换，<code>processRefPks()</code> 则进行主键过滤和权限控制，确保只有符合权限的数据行被返回。</p>
<h3 id="5-返回结果给前端"><a href="#5-返回结果给前端" class="headerlink" title="5. 返回结果给前端"></a>5. 返回结果给前端</h3><ul>
<li>最终，<code>execute()</code> 返回 <code>RefQueryResult</code> 对象，<code>doAction()</code> 将该结果封装并返回给前端。</li>
<li>前端接收 <code>RefQueryResult</code> 数据，该数据包含查询到的参照数据行和分页信息。</li>
</ul>
<h3 id="6-前端展示结果"><a href="#6-前端展示结果" class="headerlink" title="6. 前端展示结果"></a>6. 前端展示结果</h3><ul>
<li>前端接收到后端返回的参照数据，将其展示在参照弹窗中。用户可以浏览分页内容、查看参照的名称和编码等字段。</li>
<li>用户可以进一步选择或确认某个参照值，从而完成整个参照功能的交互流程。</li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">黄文胜</div><div class="post-copyright__author_desc">热爱无边，生活有度</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://hws02.github.io/2024/10/23/NCC%E6%9E%B6%E6%9E%84%E5%8F%82%E7%85%A7%E5%BC%80%E5%8F%91%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0-%E7%94%A8%E5%8F%8B%E5%AE%9E%E4%B9%A0/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://hws02.github.io/2024/10/23/NCC%E6%9E%B6%E6%9E%84%E5%8F%82%E7%85%A7%E5%BC%80%E5%8F%91%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0-%E7%94%A8%E5%8F%8B%E5%AE%9E%E4%B9%A0/')">NCC架构参照开发源码实现</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://hws02.github.io/2024/10/23/NCC%E6%9E%B6%E6%9E%84%E5%8F%82%E7%85%A7%E5%BC%80%E5%8F%91%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0-%E7%94%A8%E5%8F%8B%E5%AE%9E%E4%B9%A0/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=NCC架构参照开发源码实现&amp;url=https://hws02.github.io/2024/10/23/NCC%E6%9E%B6%E6%9E%84%E5%8F%82%E7%85%A7%E5%BC%80%E5%8F%91%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0-%E7%94%A8%E5%8F%8B%E5%AE%9E%E4%B9%A0/&amp;pic=https://bu.dusays.com/2024/10/31/6722d69dc007a.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Hws02.github.io" target="_blank">首页</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/%E5%AE%9E%E4%B9%A0/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>实习<span class="categoryesPageCount">6</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E5%8F%82%E7%85%A7/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>参照<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E7%94%A8%E5%8F%8B/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>用友<span class="tagsPageCount">2</span></a><a class="post-meta__box__tags" href="/tags/%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>源码研究<span class="tagsPageCount">1</span></a></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2024/11/07/672c76d427a25.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/10/23/TCP%20%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/07/672c7714bccfa.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">TCP 为什么需要三次握手</div></div></a></div><div class="next-post pull-right"><a href="/2024/10/23/Redis%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84%EF%BC%9F/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/07/672c7714bccfa.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis是如何实现高可用的</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/10/23/%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91/" title="接口开发"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/31/672334e540319.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-10-23</div><div class="title">接口开发</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Waline</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2021/01/15/4de65f92aefbf.gif" alt="status"/></div></div><div class="author-info__description">黄文胜的个人博客，记录Java牛马的学习笔记，成长历程。</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">黄文胜</h1><div class="author-info__desc">热爱无边，生活有度</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="tencent://Message/?Uin=1617891783&amp;amp;websiteName=local.edu.com:8888=&amp;amp;Menu=yes" target="_blank" title="QQ"><i class="anzhiyufont anzhiyu-icon-qq"></i></a><a class="social-icon faa-parent animated-hover" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=huangws2024@foxmail.com" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NCC%E6%9E%B6%E6%9E%84%E5%8F%82%E7%85%A7%E5%BC%80%E5%8F%91%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6"><span class="toc-number">1.</span> <span class="toc-text">NCC架构参照开发源码研究</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8F%82%E7%85%A7"><span class="toc-number">1.0.1.</span> <span class="toc-text">1.参照</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8F%82%E7%85%A7%E7%9A%84%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF"><span class="toc-number">1.0.2.</span> <span class="toc-text">2.参照的业务场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8F%82%E7%85%A7%E5%88%86%E7%B1%BB-%E6%A0%B7%E5%BC%8F%E6%88%AA%E5%9B%BE"><span class="toc-number">1.0.3.</span> <span class="toc-text">3. 参照分类(样式截图)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%8F%82%E7%85%A7%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.0.4.</span> <span class="toc-text">4. 参照的实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%BB%A3%E7%A0%81%E7%A0%94%E7%A9%B6"><span class="toc-number">1.0.5.</span> <span class="toc-text">5.代码研究</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%8F%82%E7%85%A7%E5%89%8D%E7%AB%AF"><span class="toc-number">1.0.6.</span> <span class="toc-text">6.参照前端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-YonBIP-%E5%8F%82%E7%85%A7%E5%88%9B%E5%BB%BA%EF%BC%88%E5%BA%94%E7%94%A8%E6%B3%A8%E5%86%8C%EF%BC%89"><span class="toc-number">1.0.7.</span> <span class="toc-text">7.YonBIP 参照创建（应用注册）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E8%AE%B2%E8%A7%A3%E6%80%9D%E8%B7%AF"><span class="toc-number">1.0.8.</span> <span class="toc-text">8.讲解思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E5%8F%82%E7%85%A7%E5%89%8D%E7%AB%AF%EF%BC%88React%EF%BC%89"><span class="toc-number">1.0.9.</span> <span class="toc-text">9.参照前端（React）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-%E5%8F%82%E7%85%A7%E5%90%8E%E7%AB%AF%EF%BC%88Java%EF%BC%89-MVC-%E6%A8%A1%E5%BC%8F%E8%AE%B2%E8%A7%A3"><span class="toc-number">1.0.10.</span> <span class="toc-text">10.参照后端（Java）-MVC 模式讲解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">具体流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%89%8D%E7%AB%AF%E8%AF%B7%E6%B1%82%E9%98%B6%E6%AE%B5"><span class="toc-number">2.0.1.</span> <span class="toc-text">1. 前端请求阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%90%8E%E7%AB%AF%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.0.2.</span> <span class="toc-text">2. 后端接收请求并初始化查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-NCCAction-doAction-%E4%BD%9C%E4%B8%BA%E6%93%8D%E4%BD%9C%E5%85%A5%E5%8F%A3"><span class="toc-number">2.0.2.1.</span> <span class="toc-text">2.1 NCCAction.doAction() 作为操作入口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%89%A7%E8%A1%8C-AbstractRefAction-execute-%E5%A4%84%E7%90%86%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6"><span class="toc-number">2.0.2.2.</span> <span class="toc-text">2.2 执行 AbstractRefAction.execute() 处理查询条件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E5%92%8C%E5%A4%84%E7%90%86%E9%98%B6%E6%AE%B5"><span class="toc-number">2.0.3.</span> <span class="toc-text">3. 数据查询和处理阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-DefaultGridRefAction-processData-%E7%94%9F%E6%88%90%E6%9F%A5%E8%AF%A2-SQL"><span class="toc-number">2.0.3.1.</span> <span class="toc-text">3.1 DefaultGridRefAction.processData() 生成查询 SQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-NCGridRefDBProcessor-queryRefPks-%E6%9F%A5%E8%AF%A2%E7%AC%A6%E5%90%88%E6%9D%A1%E4%BB%B6%E7%9A%84%E4%B8%BB%E9%94%AE"><span class="toc-number">2.0.3.2.</span> <span class="toc-text">3.2 NCGridRefDBProcessor.queryRefPks() 查询符合条件的主键</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-NCGridRefDBProcessor-getRowsByPks-%E6%9F%A5%E8%AF%A2%E5%8F%82%E7%85%A7%E6%95%B0%E6%8D%AE%E8%A1%8C"><span class="toc-number">2.0.3.3.</span> <span class="toc-text">3.3 NCGridRefDBProcessor.getRowsByPks() 查询参照数据行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-NCGridRefDBProcessor-constructResult-%E5%B0%81%E8%A3%85%E7%BB%93%E6%9E%9C"><span class="toc-number">2.0.3.4.</span> <span class="toc-text">3.4 NCGridRefDBProcessor.constructResult() 封装结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E3%80%81%E5%A4%9A%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E9%98%B6%E6%AE%B5"><span class="toc-number">2.0.4.</span> <span class="toc-text">4. 数据权限、多语言处理阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E7%BB%99%E5%89%8D%E7%AB%AF"><span class="toc-number">2.0.5.</span> <span class="toc-text">5. 返回结果给前端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%89%8D%E7%AB%AF%E5%B1%95%E7%A4%BA%E7%BB%93%E6%9E%9C"><span class="toc-number">2.0.6.</span> <span class="toc-text">6. 前端展示结果</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/11/08/Debug%E6%97%A5%E5%BF%974/" title="Debug日志1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/07/672c76d427a25.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Debug日志1"/></a><div class="content"><a class="title" href="/2024/11/08/Debug%E6%97%A5%E5%BF%974/" title="Debug日志1">Debug日志1</a><time datetime="2024-11-08T07:12:27.000Z" title="发表于 2024-11-08 15:12:27">2024-11-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/07/Debug%E6%97%A5%E5%BF%973/" title="Debug日志3"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/07/672c76d427a25.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Debug日志3"/></a><div class="content"><a class="title" href="/2024/11/07/Debug%E6%97%A5%E5%BF%973/" title="Debug日志3">Debug日志3</a><time datetime="2024-11-07T07:52:20.000Z" title="发表于 2024-11-07 15:52:20">2024-11-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/07/Debug%E6%97%A5%E5%BF%972/" title="Debug日志2"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/07/672c76d427a25.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Debug日志2"/></a><div class="content"><a class="title" href="/2024/11/07/Debug%E6%97%A5%E5%BF%972/" title="Debug日志2">Debug日志2</a><time datetime="2024-11-07T07:28:15.000Z" title="发表于 2024-11-07 15:28:15">2024-11-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/07/Debug%E6%97%A5%E5%BF%97/" title="Debug日志1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/11/07/672c76d427a25.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Debug日志1"/></a><div class="content"><a class="title" href="/2024/11/07/Debug%E6%97%A5%E5%BF%97/" title="Debug日志1">Debug日志1</a><time datetime="2024-11-07T07:12:27.000Z" title="发表于 2024-11-07 15:12:27">2024-11-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/31/ThreadPoolExecutor/" title="ThreadPoolExecutor"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/10/31/6722d71d6928b.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ThreadPoolExecutor"/></a><div class="content"><a class="title" href="/2024/10/31/ThreadPoolExecutor/" title="ThreadPoolExecutor">ThreadPoolExecutor</a><time datetime="2024-10-31T07:29:12.000Z" title="发表于 2024-10-31 15:29:12">2024-10-31</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-上班摸鱼中.svg" alt="距离月入20也就还差一个大佬带我~" title="距离月入20也就还差一个大佬带我~"/><div id="runtimeTextTip"></div></div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener" href="https://www.foreverblog.cn/">十年之约</a><a class="footer-item" title="开往" target="_blank" rel="noopener" href="https://github.com/travellings-link/travellings">开往</a></div></div><div class="footer-group"><div class="footer-title">主题</div><div class="footer-links"><a class="footer-item" title="文档" href="/docs/">文档</a><a class="footer-item" title="源码" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu">源码</a><a class="footer-item" title="更新日志" href="/update/">更新日志</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="友链文章" href="/fcircle/">友链文章</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a><a class="github-badge" target="_blank" href="https://www.dogecloud.com/" style="margin-inline:5px" data-title="本站使用多吉云为静态资源提供CDN加速" title="本站使用多吉云为静态资源提供CDN加速"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/CDN-多吉云-3693F3.svg" alt="本站使用多吉云为静态资源提供CDN加速"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"/></a><a class="github-badge" target="_blank" href="https://github.com/Hws02/Hws02.github.io" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2024 By <a class="footer-bar-link" href="/" title="黄文胜" target="_blank">黄文胜</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">4</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="http://localhost:4000/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><span> 隧道</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><span> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><span> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><span> 关于本人</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:toRandomPost()"><span> 随便逛逛</span></a></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Debug/" style="font-size: 0.88rem;">Debug<sup>4</sup></a><a href="/tags/Docker/" style="font-size: 0.88rem;">Docker<sup>1</sup></a><a href="/tags/Java/" style="font-size: 0.88rem;">Java<sup>9</sup></a><a href="/tags/MySQL/" style="font-size: 0.88rem;">MySQL<sup>2</sup></a><a href="/tags/Nacos/" style="font-size: 0.88rem;">Nacos<sup>1</sup></a><a href="/tags/Redis/" style="font-size: 0.88rem;">Redis<sup>2</sup></a><a href="/tags/TCP/" style="font-size: 0.88rem;">TCP<sup>1</sup></a><a href="/tags/%E5%85%8B%E9%9A%86/" style="font-size: 0.88rem;">克隆<sup>1</sup></a><a href="/tags/%E5%8F%82%E7%85%A7/" style="font-size: 0.88rem;">参照<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">后端开发<sup>1</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 0.88rem;">多线程<sup>1</sup></a><a href="/tags/%E5%A4%A7%E5%AD%A6/" style="font-size: 0.88rem;">大学<sup>2</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0/" style="font-size: 0.88rem;">学习<sup>1</sup></a><a href="/tags/%E5%AE%9E%E4%B9%A0/" style="font-size: 0.88rem;">实习<sup>6</sup></a><a href="/tags/%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">接口开发<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 0.88rem;">数据库<sup>5</sup></a><a href="/tags/%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6/" style="font-size: 0.88rem;">源码研究<sup>1</sup></a><a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size: 0.88rem;">生活<sup>1</sup></a><a href="/tags/%E7%94%A8%E5%8F%8B/" style="font-size: 0.88rem;">用友<sup>2</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 0.88rem;">编程<sup>1</sup></a><a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/" style="font-size: 0.88rem;">自动化部署<sup>1</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 0.88rem;">设计模式<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 0.88rem;">面试<sup>16</sup></a></div></div><hr/></div></div><div id="keyboard-tips"><div class="keyboardTitle">博客快捷键</div><div class="keybordList"><div class="keybordItem"><div class="keyGroup"><div class="key">shift K</div></div><div class="keyContent"><div class="content">关闭快捷键功能</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift A</div></div><div class="keyContent"><div class="content">打开/关闭中控台</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift M</div></div><div class="keyContent"><div class="content">播放/暂停音乐</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift D</div></div><div class="keyContent"><div class="content">深色/浅色显示模式</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift S</div></div><div class="keyContent"><div class="content">站内搜索</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift R</div></div><div class="keyContent"><div class="content">随机访问</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift H</div></div><div class="keyContent"><div class="content">返回首页</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift F</div></div><div class="keyContent"><div class="content">友链鱼塘</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift L</div></div><div class="keyContent"><div class="content">友链页面</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift P</div></div><div class="keyContent"><div class="content">关于本站</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift I</div></div><div class="keyContent"><div class="content">原版/本站右键菜单</div></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2024 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 黄文胜 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("04/01/2024 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "https://npm.elemecdn.com/anzhiyu-blog@2.0.4/img/badge/安知鱼-下班啦.svg";
        img.title = "下班了就该开开心心的玩耍，嘿嘿~";
        img.alt = "下班了就该开开心心的玩耍，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-zeta-one.vercel.app/',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-zeta-one.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  let initFn = window.walineFn || null

  const initWaline = (Fn) => {
    const waline = Fn(Object.assign({
      el: '#waline-wrap',
      serverURL: '',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: true,
      imageUploader: true,
    }, null))

    const destroyWaline = () => {
      waline.destroy()
    }

    anzhiyu.addGlobalFn('pjax', destroyWaline, 'destroyWaline')
  }

  const loadWaline = async () => {
    if (initFn) initWaline(initFn)
    else {
      await getCSS('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline.css')
      if (false) await getCSS('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline-meta.css')
      const { init } = await import('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline.js')
      initFn = init || Waline.init
      initWaline(initFn)
      window.walineFn = initFn
    }
  }

  if ('Twikoo' === 'Waline' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo-zeta-one.vercel.app/',
        region: 'ap-shanghai',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "mail: visitor@blog.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>